

## ТЗ v1.2 — Веб-приложение Heatmap загрузки ресурсов CUTEAM по фактическим визитам (YCLIENTS), 2025 + ежедневное обновление

### 1) Цель

Создать веб-приложение (frontend + backend на Python), которое:

* выгружает по API YCLIENTS фактические записи за **весь 2025 год** по **5 филиалам** CUTEAM;
* конвертирует записи в **часовую занятость ресурсов** (staff_id = ресурс/кресло/кабинет);
* группирует ресурсы по типам (группы задаются конфигом в проекте);
* показывает **недельную тепловую карту** (дни недели × часы) в процентах загрузки группы;
* позволяет выбирать **месяц 2025**, внутри него смотреть **недели** и **месячные средние**;
* ежедневно в 06:00 догружает “вчера” (для будущих лет/дальнейшего использования).

---

### 2) Входные данные, исходники, ограничения

* Полная спецификация и команды YCLIENTS API уже лежат в папке проекта (Codex использует именно её как “источник истины”). C:\Codex\Дашборд\developers.yclients.com-2026-01-19.md
* Доступы и токены у заказчика есть (в репозиторий не коммитим).
* Excel-файл с ручной теплокартой лежит в проекте — используется **только для сверки**.

---

### 3) Бизнес-правила расчёта

#### 3.1 Рабочее аналитическое окно (benchmark)

Ключевой диапазон для расчётов процентов и средних: **10:00–21:59** (часовые слоты **10, 11, …, 21**, всего 12 часов).

* Всё **до 10:00** и **после 22:00** не участвует в расчётах процентов и средних.
* Однако факт бронирований в “серой зоне” нужно показывать **как индикатор (галочка)**, без процентов.

#### 3.2 Факт визита

Учитываются только записи со статусами **“Пришёл”** и **“Выполнено”**.
Все прочие статусы трактуются как “не факт” (включая “записан, но не пришёл”, отмены и т.д.) и **не учитываются** в занятости.

> В API статусы могут быть кодами/числами — берём из приложенной спецификации.

#### 3.3 Часовые клетки: правило занятости

Шаг = **1 час**.
Если запись пересекает часовой слот хотя бы частично — этот час считается **занятым целиком**.

Пример:

* 10:50–12:10 → занятые часы: 10, 11, 12 (все = 1)
* 21:40–22:05 → час 21 = занят (учитывается), час 22 = занят, но относится к “серой зоне” (не влияет на проценты и средние).

---

### 4) Группировка ресурсов (обязательная конфигурация)

В проекте хранится конфиг-файл группировки (JSON предпочтительно, допустим CSV):

* 5 филиалов (branch/company)
* внутри филиала — несколько групп ресурсов
* каждая группа содержит список staff_ids

Правила:

* **один staff_id принадлежит только одной группе** (в рамках филиала)
* в разных филиалах разные наборы групп и разное количество staff_id в группах
* названия филиалов можно подтягивать из YCLIENTS (если удобно), но конфиг всё равно содержит mapping branch_id ↔ display_name (fallback).

---

### 5) Расчёт загрузки группы (процент)

Для филиала `B`, группы `G`, дня `D`, часа `H`:

* `N = количество staff_id в группе G`
* `busy_count = количество staff_id, занятых в этом часу` (по правилу 3.3)

`LoadPct = (busy_count / N) * 100`

---

### 6) Периоды и навигация (ключевое уточнение пользователя)

Интерфейс должен позволять выбрать **месяц** (например, “Январь 2025”).

Для выбранного месяца:

* показываются данные по неделям (Пн–Вс) внутри месяца:

  * либо листание по неделям кнопками “← неделя / неделя →”
  * либо список недель месяца (dropdown)
* плюс показывается **месячная сводка** (средняя загрузка за месяц по benchmark-окну)

Не нужно делать аналитику “несколько месяцев вместе” — только выбор одного месяца и просмотр.

---

### 7) UI/UX требования (Frontend)

#### 7.1 Экран Dashboard (основной)

Элементы:

1. Выбор **месяца** (Янв 2025 … Дек 2025)

2. Выбор **филиала** (из 5)

3. Выбор **группы ресурсов** (из конфига для филиала)

4. Выбор **недели** внутри выбранного месяца (dropdown или prev/next)

5. Отображение:

   * Недельная теплокарта **7×12** (Пн–Вс × часы 10–21)
   * Цветовая шкала **10 градаций**: синий (0%) → зелёный (≈50%) → красный (100%)
   * Tooltip: день/час, LoadPct, busy_count/N

6. “Серая зона”:

   * для часов <10 и ≥22 отображать **индикатор наличия бронирований** (галочка/точка)
   * без процентов и без участия в средних
   * можно показать отдельно, компактно (например, строкой “раньше 10” и “после 22” по дням недели, или тонкими столбцами вне основной сетки — на усмотрение разработчика, главное не путать с процентами)

7. Сводные метрики:

   * средняя загрузка за день (по 12 часам 10–21)
   * средняя за неделю (по 7×12)
   * средняя за месяц (по всем дням месяца × 12)

#### 7.2 Экран Admin

* кнопка “Полная загрузка 2025”
* показ статуса/прогресса (в процентах или “шаг/всего” + логи ошибок)
* кнопка “Пересчитать агрегаты” (опционально)
* показ времени последнего успешного обновления

#### 7.3 Авторизация

MVP: 2 учётки:

* `admin`
* `admin2`
  Логин/пароль через переменные окружения (.env), сессия cookie 12 часов.

---

### 8) Backend (Python) — функциональные требования

#### 8.1 Компоненты

* API-клиент YCLIENTS (по документации из папки проекта)
* Модуль загрузки данных (ETL):

  * полная загрузка за 2025
  * ежедневная загрузка за вчера
* Модуль агрегации:

  * построение занятости staff по часам
  * агрегация по группам
  * вычисление средних (день/неделя/месяц)
* REST API для фронта
* Планировщик (06:00 daily)

#### 8.2 Хранилище данных

MVP: SQLite (файл БД).

Таблицы (минимум):

1. `raw_records`

* branch_id
* staff_id
* record_id (уникален в рамках branch)
* start_dt
* end_dt (если нет — вычислять по длительности)
* status_code/status_name
* updated_at

2. `staff_hour_busy`

* branch_id
* staff_id
* date
* hour (0–23)
* busy_flag (0/1) — занят ли час целиком
* in_benchmark (0/1) — hour ∈ {10..21}
* in_gray (0/1) — hour <10 or hour >=22 (если был факт брони)

3. `group_hour_load`

* branch_id
* group_id
* date
* dow (1–7)
* hour (0–23)
* busy_count
* staff_total
* load_pct
* in_benchmark (0/1)

4. `etl_runs` (статусы загрузок)

* run_id
* run_type (full_2025 / daily)
* started_at
* finished_at
* status (running/success/failed)
* progress (0–100 или текст)
* error_log (текст)

#### 8.3 ETL: Полная загрузка 2025 (ручной запуск)

* Выгрузить records за 2025 по всем 5 филиалам:

  * постранично
  * с ретраями
  * с дедупликацией по record_id
* Сохранить `raw_records`
* Построить `staff_hour_busy`:

  * для каждой записи определить часы, которые она занимает (включая серую зону)
  * отмечать busy_flag=1 по всем пересечённым часам
* Построить `group_hour_load`:

  * для каждого дня и часа посчитать busy_count и процент по группам (из конфига)

#### 8.4 ETL: Ежедневная загрузка (06:00)

* Период: вчера 00:00–23:59 (Europe/Moscow)
* Выгрузить, upsert в raw
* Пересчитать staff_hour_busy и group_hour_load только за вчера (и, при необходимости, пересчитать недельные/месячные средние на лету)

---

### 9) REST API для фронта (минимальный контракт)

1. Получить список филиалов

* `GET /api/branches`

2. Получить группы для филиала

* `GET /api/branches/{branch_id}/groups`

3. Получить список недель в месяце (для выбора)

* `GET /api/months/2025-01/weeks` → массив week_start_dates

4. Данные теплокарты за неделю

* `GET /api/heatmap?branch_id=...&group_id=...&week_start=YYYY-MM-DD`
  Ответ:
* матрица 7×12 по hours 10..21
* дополнительно индикаторы серой зоны (раньше/позже) по дням

5. Сводка за месяц

* `GET /api/summary/month?branch_id=...&group_id=...&month=2025-01`
  Ответ:
* avg_day (опционально массив)
* avg_week (опционально)
* avg_month (обязательно)

6. Админ: старт полной загрузки

* `POST /api/admin/etl/full_2025/start`

7. Админ: статус загрузки

* `GET /api/admin/etl/status`

---

### 10) Деплой и репозиторий

* GitHub public repo
* Render (free tier)
* Secrets в Render env vars:

  * токены YCLIENTS
  * пароли admin/admin2
  * путь к конфигу групп
  * timezone

Ок, что сервис “просыпается” после простоя (не критично).

---

### 11) Критерии приёмки (DoD)

1. Полная загрузка 2025 выполняется и сохраняет данные
2. Выбор “месяц → филиал → группа → неделя” отображает корректную теплокарту 7×12 (10..21)
3. Процент и цвета соответствуют бизнес-правилам
4. Серая зона отображает только “факт наличия брони” (галочка), не влияет на проценты/средние
5. Средние (день/неделя/месяц) считаются только по 10..21
6. Админка показывает прогресс и финальный статус загрузок
7. Сверка с Excel на выбранной контрольной неделе: расхождения объяснимы и минимальны (ожидаемо возможны различия из-за ручного ввода)

---

## Задачи для Codex (как план разработки)

1. Подготовить структуру репозитория (backend+frontend, конфиги, README)
2. Реализовать YCLIENTS API client по документации из папки проекта
3. Реализовать ETL full_2025 (с прогрессом)
4. Реализовать ETL daily (scheduler 06:00)
5. Реализовать агрегации staff_hour_busy и group_hour_load
6. Реализовать REST API для фронта
7. Реализовать frontend dashboard (heatmap + фильтры месяц/неделя/филиал/группа)
8. Реализовать “серую зону” индикаторами
9. Реализовать авторизацию admin/admin2
10. Подготовить Render deployment (Procfile/Start command/requirements)

---

## Оставшиеся уточнения (минимум, но желательно сразу)

1. **5 филиалов в YCLIENTS**: это 5 отдельных `company_id` или 1 `company_id` + 5 `location_id`?
   (Нужно, чтобы правильно разделять данные при выгрузке.)

2. **Статусы “Пришёл/Выполнено” в API**: какие именно значения поля (код/строка)?
   Ты сказал, что документация лежит в папке — Codex может взять оттуда. Но в ТЗ стоит явно зафиксировать: поле и допустимые значения.

Если хочешь — можешь просто написать:

* “филиалы: 5 company_id” или “1 company_id + locations”
  и всё. Остальное Codex доберёт из вашей API-папки без вопросов.
