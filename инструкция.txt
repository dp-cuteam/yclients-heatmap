ИНСТРУКЦИЯ (детальная, обновлённая)

1) Назначение системы
CUTEAM Heatmap — веб‑приложение для визуализации загрузки рабочих мест/кабинетов по фактическим визитам из YCLIENTS. 
Основной экран показывает тепловую карту за выбранный месяц: строки — часы, столбцы — дни, блоки — группы ресурсов.
Отдельно поддерживается «Исторические данные» (импорт из Excel) — это независимый набор данных.

2) Архитектура (высокий уровень)
Слои:
- Frontend (HTML/CSS/JS): визуализация теплокарт, фильтры, статусные блоки, админ‑панель.
- Backend (FastAPI): API для данных, ETL‑процессы, диагностика, импорт Excel, авторизация.
- Хранилища:
  - Основная БД (SQLite или Postgres через DATABASE_URL): фактические визиты и агрегаты.
  - Историческая БД (SQLite): импорт из Excel.
  - Файлы конфигурации групп (config/groups.json и groups_resolved.json).

3) Основные директории
- backend/app/main.py — маршруты API и страниц.
- backend/app/etl.py — ETL загрузки из YCLIENTS (полная/дневная).
- backend/app/historical.py — импорт Excel и выдача исторической теплокарты.
- backend/app/diagnostics.py — диагностика YCLIENTS + support packet.
- backend/app/static/* — JS/CSS фронта.
- backend/app/templates/* — HTML шаблоны.
- config/groups.json — конфиг групп ресурсов по филиалам.
- data/app.db — основная БД (SQLite по умолчанию).
- data/historical.db — БД исторических данных.

4) Данные и схема БД (основной поток)
Основная БД:
- raw_records
  - branch_id, staff_id, record_id, start_dt, end_dt, attendance, updated_at
  - первичный ключ (branch_id, record_id)
- staff_hour_busy
  - признак занятости конкретного сотрудника по часу
- group_hour_load
  - агрегат по группе ресурсов и часу
  - поля: busy_count, staff_total, load_pct, in_benchmark
- etl_runs
  - журнал запусков ETL (тип, статус, прогресс, ошибки)

Историческая БД:
- historical_loads (branch_id, month, resource_type, date, hour, load_pct)
- historical_types (порядок типов в Excel)
- historical_imports (журнал импортов)

5) Поток данных (основная теплокарта)
1) ETL получает записи из YCLIENTS
2) нормализует их → raw_records
3) строит почасовую занятость по сотрудникам → staff_hour_busy
4) агрегирует по группам → group_hour_load
5) фронт запрашивает агрегацию за месяц → теплокарта

6) ETL: режимы
Полная загрузка:
- выполняется кнопкой в админке
- запускается через POST /api/admin/etl/full_2025/start
- период: с 2025‑01‑01 по текущую дату (по часовому поясу APP_TIMEZONE)
- пересчитывает агрегаты полностью

Дневная загрузка:
- выполняется кнопкой «Дневная загрузка (вчера)»
- POST /api/admin/etl/daily/start
- подхватывает записи за вчерашний день
- дополняет существующие данные

Планировщик (если ENABLE_SCHEDULER=1):
- ежедневно в 06:00 (APP_TIMEZONE)
- запускает дневную загрузку

7) Исторические данные (Excel)
Импортируются из файла:
- по умолчанию: «Загруженность площадки (тепловая карта).xlsx»
- путь можно переопределить через HISTORICAL_XLSX_PATH

В админке:
- «Импортировать» = append (добавляет новые данные)
- «Переимпортировать» = replace (полная пересборка исторической БД)

Исторические данные независимы от основной БД.

8) Конфиг групп и названия филиалов
Файл: config/groups.json
Структура:
- branches[] → branch_id, display_name, groups[]
- groups[] → name, staff_names[], staff_ids[]

Важно:
- При ETL имена сотрудников сопоставляются с staff_names
- При загрузке приложение может подтянуть display_name филиала из YCLIENTS
  и записать в groups_resolved.json
- Если токены не дают доступ к названию — display_name останется числом

9) Сортировка блоков в теплокарте
Порядок вывода групп (на основном и историческом экране):
1) Рабочие места парикмахеров
2) Рабочие места визажистов
3) Рабочие места мастеров маникюра/педикюра
4) Кабинеты — по номеру (№1, №2, ...)
5) Остальное — в конце

10) Логика месяцев
Основная теплокарта:
- список месяцев приходит с сервера (/api/months)
- сортировка: от свежего к старому
- по умолчанию выбран самый свежий месяц (включая неполный текущий)

Исторические данные:
- список месяцев по филиалу сортируется от свежего к старому

11) UI разделы
- /login — вход
- / — основная теплокарта
- /historical — историческая теплокарта
- /admin — админка (ETL + исторические данные + диагностика)

12) Диагностика YCLIENTS
Встроена в /admin.
Что показывает:
- токены (маскированно), часовой пояс, среда
- доступ к компаниям/филиалам
- доступ к сотрудникам
- доступ к записям за день
- логи запросов
- support packet (MD/JSON)

13) Webhook YCLIENTS
Endpoint:
POST /api/webhooks/yclients
Минимально принимает входящие события и пишет в лог.

14) Переменные окружения (.env)
Ключевые:
YCLIENTS_PARTNER_TOKEN=...
YCLIENTS_USER_TOKEN=...
APP_TIMEZONE=Europe/Moscow
DATA_DIR=./data
DB_PATH=./data/app.db
GROUP_CONFIG_PATH=./config/groups.json
GROUP_CONFIG_RESOLVED_PATH=./config/groups_resolved.json
HISTORICAL_XLSX_PATH=... (опционально)
ENABLE_SCHEDULER=0/1

15) Запуск локально
- активировать venv
- uvicorn backend.app.main:app --reload

16) Деплой (Render)
- Procfile: web: uvicorn backend.app.main:app --host 0.0.0.0 --port $PORT
- В Render задать все переменные из .env
- Включить постоянный диск для DATA_DIR

17) Типовые проблемы
- 401/403: токены или права пользователя
- 404: неверный endpoint/branch_id
- 429: лимиты YCLIENTS
- Пустая теплокарта за свежие даты: запускалась только дневная загрузка, нужна полная
- Исторические данные не видны: не выполнен импорт Excel

18) Telegram mini app (лаборатория, товары по граммам)
Цель: администратор за 15–30 секунд добавляет товары (краска/шампунь) в активную запись.

Экран 1: Активные записи
- список на сегодня/ближайшие N часов
- поля: время, мастер, клиент (если нужно), статус (ожидает/в процессе)
- фильтры: сейчас/сегодня, поиск по мастеру/клиенту, переключатель филиала
- клик по записи → экран 2

Экран 2: Добавление товаров в выбранную запись
- шапка записи (время, мастер)
- поле поиска товара (фокус сразу)
- подсказки/история: последние 10 позиций
- результаты: список (название + цена/грамм)
- после выбора товара: поле «Граммы» + быстрые кнопки +5 / +10 / +20 / +50
- кнопка «Добавить в запись»
- опционально: локальная корзина (что добавили в этой сессии) + «Отменить последнюю»

Требования к скорости
- поиск стартует с 2–3 символов
- debounce 200–300 мс
- лимит выдачи 20–30 позиций
- сортировка: сначала точные совпадения, затем вхождение
- кэш поисковых запросов на 5–15 минут

Источник товаров
- предпочтительно: локальный индекс товаров на сервере (обновляется кнопкой в админке)
- альтернативно: прямой поиск в YCLIENTS (через backend, без токенов на клиенте)

Как добавить товар в запись (через backend)
1) Получить record_id выбранной записи.
2) Получить good_id выбранного товара.
3) Вызвать YCLIENTS: 
   PUT /api/v1/technological_cards/record_consumables/consumables/{company_id}/{record_id}/{service_id}/
   Payload: consumables[] с good_id, amount (граммы), price, storage_id и др.
4) Отобразить результат в интерфейсе (успех/ошибка).

Важно:
- запросы в YCLIENTS выполняются только с сервера
- токены не передаются на телефон

Права, безопасность, аудит
- Telegram user сопоставляется с администратором (однократная привязка)
- сервер ведёт журнал: кто/когда/в какую запись/какой товар/сколько грамм

Обработка ошибок
- ошибки YCLIENTS: показать понятное сообщение и кнопку «Обновить список записей»
- отсутствие интернета: в MVP просто ошибка, в v2 — локальный черновик

Если нужно дополнить инструкцию под конкретный филиал (например 1213086) — сообщите название и особенности группы, добавлю отдельный раздел.
