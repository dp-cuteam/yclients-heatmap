ИНСТРУКЦИЯ (обновлённая)

1) Назначение
Приложение CUTEAM Heatmap показывает загрузку ресурсов по фактическим визитам YCLIENTS за 2025 год. Дашборд отображает месяц целиком, разбитый на недели (Пн–Вс), с итогами по дням, неделям и месяцу.

2) Основные разделы UI
- Вход: /login
- Дашборд (теплокарта): /
- Админка ETL: /admin
- Диагностика YCLIENTS: /admin/diagnostics

3) Настройка токенов
Нужны:
- Partner token (общий)
- User token (с правами на все 5 филиалов)

Рекомендуется хранить в .env:
YCLIENTS_PARTNER_TOKEN=...
YCLIENTS_USER_TOKEN=...

Либо partner token можно оставить в файле:
C:\Codex\Дашборд\api token.txt
(в файле должна быть ровно 1 строка — только токен, без лишних слов)

4) Переменные окружения (.env)
Пример:
YCLIENTS_PARTNER_TOKEN=...
YCLIENTS_USER_TOKEN=...
YCLIENTS_BASE_URL=https://api.yclients.com
YCLIENTS_TIMEOUT=30
YCLIENTS_RETRIES=3
SESSION_SECRET=...
ADMIN_USER=admin
ADMIN_PASS=...
ADMIN2_USER=admin2
ADMIN2_PASS=...
APP_TIMEZONE=Europe/Moscow
DATA_DIR=./data
DB_PATH=./data/app.db
GROUP_CONFIG_PATH=./config/groups.json
GROUP_CONFIG_RESOLVED_PATH=./config/groups_resolved.json

5) Запуск локально
- Активировать venv
- Запустить:
  uvicorn backend.app.main:app --reload

6) Диагностика YCLIENTS (важно)
URL: /admin/diagnostics

На странице:
A) Статус конфигурации
- Партнёрский токен (маскирован)
- Пользовательский токен (маскирован)
- Часовой пояс
- Среда (Local/Render)
- Последняя попытка
Кнопка: «Запустить проверку»

B) Результаты тестов (таблица)
- Доступ по токену
- Филиалы доступны
- Конфигурация групп (JSON + BOM-safe)
- Сотрудники/ресурсы доступны
- Записи за день

Поля:
- Статус (ОК / Ошибка / Предупреждение)
- HTTP код
- Время ответа
- Сообщение (по-русски)
- Детали (JSON, без токенов)

C) Логи
- Логи диагностики пишутся в data/logs/yclients_diag_YYYY-MM-DD.log
- Кнопка: «Показать последние 200 строк»
- Кнопка: «Скачать лог»

7) Дашборд: логика месяца
Фильтры:
- Месяц
- Филиал
- Группа ресурсов

Отображение:
- Месяц целиком блоками недель (Пн–Вс)
- Внутри недели: строки по дням, колонки по часам 10–21
- Итог дня (средняя за 10–21)
- Итог недели (средняя за 10–21)
- Итог месяца (средняя за 10–21)
- Серая зона (<10 и >=22) показывает только факт наличия брони и НЕ влияет на проценты

8) ETL
Полная загрузка 2025:
POST /api/admin/etl/full_2025/start

Статус:
GET /api/admin/etl/status

Ежедневный ETL запускается планировщиком в 06:00 (Europe/Moscow).

9) Вебхук (требование YCLIENTS)
Эндпоинт для вебхуков:
POST /api/webhooks/yclients

Нужен публичный HTTPS URL:
- Render: https://<app>.onrender.com/api/webhooks/yclients
- ngrok: https://<id>.ngrok.io/api/webhooks/yclients

10) BOM-safe для конфигов
Все JSON-конфиги читаются с encoding="utf-8-sig". Ошибка BOM устранена.

11) Типичные ошибки
- Таймаут к api.yclients.com → проблема сети/доступа (см. диагностику)
- 401 → неверный токен
- 403 → нет прав пользователя
- 404 → неверный endpoint или branch_id
- 429 → лимиты

12) Render деплой
- Используется Procfile:
  web: uvicorn backend.app.main:app --host 0.0.0.0 --port $PORT
- В Render задать все переменные из .env
