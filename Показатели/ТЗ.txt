

Исходные данные в структуре версия 1
C:\Codex\Показатели\Структура.xlsx

данные в структуре может чуть отличаться и не полная но берем за основу
C:\Codex\Показатели\Ежедневные и ежемесячные показатели Cuteam.xlsx

Общая логика дашбордов ТЗ
C:\Codex\Показатели\Ежедневные.txt

Визуальное оформление ТЗ
C:\Codex\Показатели\Визуал.txt



ТЗ ДЛЯ CODEX: ЭТАП 1 (MVP, Вариант A)
Контекст

Есть Google-таблица “Ежедневные и ежемесячные показатели Cuteam”, которая ведётся руками. Формат: дни в столбцах, статьи в строках, внутри есть итоги недель и месяцев. Таблица удобна как “сырой месяц”, но неудобна для дашбордов и ненадёжна как единственный источник данных.

Цель этапа 1:

привести Google-таблицу к канонической структуре (коды показателей, единый справочник строк, добавление строки чеков),

настроить архитектуру Вариант A:

БД — источник истины

Yclients тянем в БД по API (авто-поля)

из Google Sheet тянем в БД всё остальное (ручные поля)

в приложении показываем управленческий экран + “сырой месяц” (таблица), но это будет делать следующий этап; сейчас главное — таблица и синк

ЧАСТЬ 1. Google Sheet: финальная структура для ведения (канонизация)
1.1. Требования к структуре листа “ИТОГО-26” (и/или “ИТОГО-25” как шаблон)

Оставляем концепцию: дни = столбцы, статьи = строки. Это не менять.

Нужно добавить “технический слой”, чтобы таблицу можно было надёжно парсить и маппить:

(A) Добавить слева 2 фиксированных столбца

Слева от “статья” добавить:

metric_code — технический код строки (уникальный, латиница, snake_case)

source — источник данных: manual или yclients (или computed для вычисляемых в приложении/БД)

Структура первых колонок:

metric_code | статья | далее идут дневные колонки

(B) Условия для metric_code

уникален в рамках листа

не зависит от названия “статья” (название можно менять, код — нет)

используется для сопоставления с БД и API

(C) Добавить строку чеков для кофейни

Добавить строку:

coffee_checks | Чеки (кофейня) | значения по дням

Это обязательная строка.

(D) Согласовать перечень строк под MVP (и проставить source)

Список показателей, которые должны быть в таблице (минимально необходимо):

Коворкинг (факт, руб)

revenue_open_space | Аренда общий зал | source = (уточнить: manual/yclients)

revenue_cabinets | Кабинеты | source = manual

revenue_lab | Лаборатория | source = manual

revenue_retail | Ритейл | source = manual

Кофейня (факт, руб/шт)

coffee_revenue_total | Кофейня выручка всего | source = (уточнить: manual/yclients)

coffee_checks | Чеки (кофейня) | source = (уточнить: manual/yclients)

revenue_coffee_hot | Кофе/горячие | source = (уточнить: manual/yclients)

revenue_drinks_cold | Напитки холодильник | source = (уточнить: manual/yclients)

revenue_desserts | Десерты | source = (уточнить: manual/yclients)

revenue_food | Еда | source = (уточнить: manual/yclients)

Еда и списания (ручное)

sold_food_total | Продано еды всего | source = manual

written_off_food_total | Списание еды всего | source = manual

Примечание: если “Продано еды всего” нет как отдельного ручного поля, Codex должен предложить вариант:

либо вводить руками

либо считать как revenue_food + revenue_desserts (но это уже выручка, а не “продано”, поэтому это разные сущности; нужно уточнение)

(E) Плановые показатели месяца (ручной ввод)

В конце листа (справа) добавить 2 колонки:

plan_month — план на месяц (ручной ввод)

plan_comment — комментарий к плану (опционально)

Плановые поля нужны только для ключевых строк:

revenue_open_space

revenue_cabinets

revenue_lab

revenue_retail

coffee_revenue_total

coffee_checks (опционально)

Codex должен предложить, как технически реализовать план:

либо отдельный диапазон/таблица “ПЛАН” на том же листе

либо две колонки справа с планом по строкам (предпочтительно для MVP)

1.2. Нормализация заголовков дат

Codex должен обеспечить, чтобы парсер корректно определял, какие колонки являются “днями”.

Условия:

дневные колонки содержат дату (тип Date в Google Sheets)

недельные/месячные колонки (W01/M01) не должны мешать чтению дневных данных

итоговые колонки (Итого неделя, Итого месяц) можно оставить как визуальные, но парсер должен их игнорировать

1.3. Инструкции пользователю (мне) по доступам

Codex должен дать пошагово:

как выдать доступ service account к Google Sheet (email сервисного аккаунта шарится как Viewer/Editor)

какие переменные окружения нужно положить на Render (JSON key / base64 key)

как проверить доступ тестовым запросом

ЧАСТЬ 2. Архитектура Вариант A (MVP): Yclients + Sheet → БД
2.1. Принцип

БД — единственный источник истины

Sheet — интерфейс ручного ввода + “сырой месяц”

Авто-данные из Yclients пишем в БД

Ручные данные из Sheet пишем в БД

Итоговый слой fact_daily — merge авто+ручное (manual перекрывает auto)

2.2. Что нужно сделать Codex (в коде, но без фронта на этом этапе)
(A) Таблицы в БД (минимально)

raw_yclients_daily — авто-данные (по дням, по метрикам)

manual_sheet_daily — ручные значения из Sheet (по дням, по метрикам)

fact_daily (view или таблица) — итоговая витрина (merge)

Формат хранения (long format):

date

metric_code

value

source (yclients/manual)

updated_at

(B) Sync job 1: Yclients → DB

Задача:

Codex должен определить, какие из metric_code можно получить из Yclients API:

как минимум кофейня и/или услуги, если это в Yclients

Если по Yclients не очевидно — Codex должен:

сформулировать список уточняющих вопросов ко мне

и дать план, как это проверить в документации Yclients и в данных

Результат:

функция sync_yclients(date_from, date_to) которая пишет в raw_yclients_daily

(C) Sync job 2: Google Sheet → DB (ручные данные)

Задача:

читать лист “ИТОГО-26” (и аналогично “ИТОГО-25” как история при необходимости)

парсить только строки source=manual

игнорировать недельные/месячные колонки

складывать в manual_sheet_daily (upsert)

Результат:

функция sync_sheet_manual(month) или sync_sheet_manual(date_from, date_to)

(D) Merge layer: fact_daily

Логика:

если в manual_sheet_daily есть запись на (date, metric_code) — она заменяет auto

иначе берём auto

Результат:

view fact_daily или материализованная таблица

2.3. Список ключевых вычислений, которые понадобятся позже (но закладываем коды)

Codex должен заранее зарезервировать вычисляемые метрики (computed), но не обязательно реализовывать на этапе 1:

Коворкинг

lab_to_open_space_ratio = revenue_lab / revenue_open_space (computed)

Кофейня

avg_check = coffee_revenue_total / coffee_checks (computed)

writeoff_rate_food = written_off_food_total / (sold_food_total + written_off_food_total) (computed)

2.4. Запуск (Render / локально)

Codex должен предложить:

запуск синков локально (ручной запуск командой)

и схему Render Cron Job для ежедневного синка (но подключение cron можно оставить на этап 2, если хотите)

ЧАСТЬ 3. Результаты работы Codex (что должно быть на выходе)

Чёткая спецификация: какие строки остаются, какие добавляются, какие переименуются

Таблица соответствия:

metric_code → статья → source → “берём из Yclients или руками”

Пошаговая инструкция:

как обновить Google Sheet (какие столбцы и строки добавить)

как выдать доступ сервисному аккаунту

Рабочий код (Python) для:

чтения Google Sheets приватно (service account)

синка manual → DB

синка Yclients → DB (минимально, с заглушками там, где нужны уточнения)

сборки fact_daily

Мини-тесты/проверки:

что за выбранный месяц выгружается нужное число дат

что метрики читаются и маппятся по metric_code