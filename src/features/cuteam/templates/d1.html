<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cuteam · Коворкинг + Кофейня</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <style>
      .cuteam-card {
        background: var(--shell);
        border-radius: var(--radius-lg);
        padding: 18px;
        box-shadow: var(--shadow);
        margin-top: 20px;
      }

      .card-head {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .card-title {
        margin: 6px 0 0;
        font-size: 18px;
      }

      .card-subtitle {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
      }

      .card-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .copy-status {
        font-size: 12px;
        color: var(--muted);
      }

      .legend-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 16px;
        color: var(--muted);
        font-size: 12px;
        align-items: center;
      }

      .legend-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--card);
        border-radius: 999px;
        padding: 6px 12px;
        border: 1px solid var(--border-soft);
      }

      .pill-dot {
        width: 10px;
        height: 10px;
        border-radius: 3px;
        display: inline-block;
      }

      .pill-week {
        background: rgba(217, 154, 131, 0.35);
      }

      .pill-month {
        background: rgba(247, 201, 118, 0.4);
      }

      .pill-plan {
        background: rgba(233, 189, 166, 0.35);
      }

      .d1-scroll {
        overflow: auto;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-soft);
        background: var(--card);
        max-height: 70vh;
      }

      .d1-table {
        border-collapse: separate;
        border-spacing: 0;
        min-width: 980px;
        width: 100%;
      }

      .d1-table th,
      .d1-table td {
        padding: 6px 8px;
        border-bottom: 1px solid var(--border-soft);
        border-right: 1px solid var(--border-soft);
        font-size: 12px;
        line-height: 1.2;
        text-align: right;
        white-space: nowrap;
        font-family: var(--font-body);
      }

      .d1-table thead th {
        position: sticky;
        top: 0;
        background: var(--card);
        z-index: 5;
        font-weight: 600;
      }

      .d1-table th.metric-col {
        text-align: left;
        min-width: 230px;
        max-width: 260px;
      }

      .d1-table th.unit-col {
        min-width: 70px;
        text-align: center;
      }

      .sticky-col {
        position: sticky;
        left: 0;
        background: var(--card);
        z-index: 4;
        box-shadow: 2px 0 0 var(--border-soft);
      }

      .sticky-col.unit-col {
        left: 230px;
        z-index: 4;
      }

      .d1-table thead th.sticky-col {
        z-index: 7;
      }

      .raw-table th,
      .raw-table td {
        font-size: 11px;
        padding: 5px 6px;
      }

      .day-weekend {
        color: var(--accent);
        font-weight: 600;
      }

      .compare-table th.metric-col {
        min-width: 240px;
      }

      .year-table th.metric-col {
        min-width: 220px;
      }

      .year-table th.year-head {
        text-align: center;
      }

      .year-table th.month-head {
        font-size: 11px;
        text-align: center;
      }

      .year-table thead th {
        position: sticky;
        top: 0;
        background: var(--card);
        z-index: 6;
      }

      .year-table thead th.metric-col {
        z-index: 8;
      }

      .year-table td.plan-col input {
        width: 100%;
        min-width: 70px;
      }

      .raw-table th.metric-col {
        min-width: 280px;
        max-width: 320px;
      }

      .group-row th {
        background: rgba(233, 189, 166, 0.3);
        font-weight: 600;
        text-align: left;
        color: var(--ink);
      }

      .group-label {
        min-width: 300px;
        text-align: left;
      }

      .group-fill {
        background: rgba(233, 189, 166, 0.3);
        border-bottom: 1px solid var(--border-soft);
      }

      .week-total {
        background: rgba(233, 189, 166, 0.2);
        font-weight: 600;
      }

      .month-total {
        background: rgba(247, 201, 118, 0.35);
        font-weight: 600;
      }

      .plan-col {
        background: rgba(217, 154, 131, 0.2);
      }

      .d1-table td.plan-col input {
        width: 100%;
        border: 1px solid var(--border);
        background: var(--card);
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 12px;
        text-align: right;
      }

      .plan-status {
        margin-left: auto;
        font-size: 12px;
        color: var(--muted);
      }

      .day-head {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      }

      .day-head strong {
        font-size: 12px;
      }

      .day-head span {
        font-size: 10px;
        color: var(--muted);
      }

      .toggle-group {
        display: flex;
        gap: 8px;
      }

      .toggle-group label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--muted);
      }

      .empty-state {
        padding: 24px;
        text-align: center;
        color: var(--muted);
      }

      .delta-positive {
        color: #1f5e46;
        font-weight: 600;
      }

      .delta-negative {
        color: #8b1e1e;
        font-weight: 600;
      }

      .zero-value {
        color: var(--accent);
        font-weight: 600;
      }

      .raw-header {
        font-weight: 700;
      }

      .fact-above {
        color: #1f5e46;
        font-weight: 600;
      }

      .fact-below {
        color: #8b1e1e;
        font-weight: 600;
      }

      .section-divider {
        height: 3px;
        border-radius: 999px;
        background: var(--ink);
        opacity: 0.2;
        margin: 28px 0 18px;
      }

      .overview-grid {
        display: grid;
        gap: 12px;
      }

      .overview-item {
        background: var(--card);
        border: 1px solid var(--border-soft);
        border-radius: var(--radius-md);
        padding: 14px;
      }

      .overview-item h3 {
        margin: 0 0 6px;
        font-size: 15px;
      }

      .overview-item p {
        margin: 0;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.4;
      }

      @media (min-width: 960px) {
        .overview-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 12px;
        margin-top: 8px;
      }

      .kpi-tile {
        background: var(--card);
        border: 1px solid var(--border-soft);
        border-radius: var(--radius-md);
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .kpi-title {
        font-size: 12px;
        color: var(--muted);
      }

      .kpi-value {
        font-size: 18px;
        font-weight: 600;
      }

      .kpi-sub {
        font-size: 12px;
        color: var(--muted);
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }

      .chart-card {
        background: var(--card);
        border: 1px solid var(--border-soft);
        border-radius: var(--radius-md);
        padding: 12px;
        min-height: 120px;
      }

      .chart-title {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 8px;
      }

      .table-wrap {
        margin-top: 12px;
        overflow: auto;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-soft);
        background: var(--card);
      }

      .mini-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .mini-table th,
      .mini-table td {
        padding: 8px 10px;
        border-bottom: 1px solid var(--border-soft);
        text-align: right;
        white-space: nowrap;
      }

      .mini-table th:first-child,
      .mini-table td:first-child {
        text-align: left;
      }

      .sparkline {
        width: 100%;
        height: 80px;
      }

      .stack-bar {
        display: flex;
        height: 14px;
        border-radius: 999px;
        overflow: hidden;
        background: rgba(58, 58, 58, 0.1);
      }

      .stack-row {
        display: grid;
        grid-template-columns: 70px 1fr;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        margin-bottom: 8px;
      }

      .stack-label {
        color: var(--muted);
      }

      .scatter {
        width: 100%;
        height: 140px;
      }

      .status-pill {
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.02em;
      }

      .status-ok {
        background: rgba(47, 125, 85, 0.15);
        color: #1f5e46;
      }

      .status-alert {
        background: rgba(178, 65, 46, 0.15);
        color: #8b1e1e;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="topbar">
        <div>
          <div class="eyebrow">Cuteam</div>
          <h1>Дашборд / Коворкинг + Кофейня</h1>
          <p class="subtitle">Данные из Google Sheet · дни/недели</p>
        </div>
        <div class="actions">
          <a class="ghost" href="/cuteam">Показатели</a>
          <a class="ghost" href="/">Теплокарта</a>
          <a class="ghost" href="/historical">Исторические</a>
          <a class="ghost" href="/summary">Свод</a>
          <a class="ghost" href="/admin">Админка</a>
        </div>
      </header>

      <section class="filters">
        <div class="field" id="branchField">
          <label>Филиал</label>
          <select id="branchSelect"></select>
        </div>
        <div class="field">
          <label>Месяц</label>
          <select id="monthSelect"></select>
        </div>
        <div class="field">
          <label>Месяц сравнения</label>
          <select id="compareMonthSelect"></select>
        </div>
        <div class="field">
          <label>Сравнение</label>
          <div class="toggle-group">
            <label><input type="radio" name="scale" value="weeks" checked /> Недели</label>
            <label><input type="radio" name="scale" value="months" /> Месяц</label>
          </div>
        </div>
      </section>

      <section class="cuteam-card">
        <div class="card-head">
          <div>
            <div class="eyebrow">Сырой месяц</div>
            <h2 class="card-title">Исходные данные по дням</h2>
            <div class="card-subtitle">Полная таблица из Google Sheet (без сравнений)</div>
          </div>
          <div class="card-actions">
            <button class="ghost" id="rawCopyBtn" type="button">Скопировать TSV</button>
            <div class="plan-status" id="rawCopyStatus"></div>
          </div>
        </div>
        <div id="rawTableContainer" class="d1-scroll">
          <div class="empty-state">Загрузка данных…</div>
        </div>
      </section>

      <section class="cuteam-card">
        <div class="card-head">
          <div>
            <div class="eyebrow">Свод</div>
            <h2 class="card-title">Агрегированные показатели в динамике</h2>
            <div class="card-subtitle">Недели предыдущего месяца и выбранного месяца (если 6 недель — последние 5)</div>
          </div>
          <div class="card-actions">
            <button class="ghost" id="summaryCopyBtn" type="button">Скопировать TSV</button>
            <div class="copy-status" id="summaryCopyStatus"></div>
            <div class="plan-status" id="planStatus"></div>
          </div>
        </div>
        <div id="tableContainer" class="d1-scroll">
          <div class="empty-state">Загрузка данных…</div>
        </div>
      </section>

      <section class="cuteam-card">
        <div class="card-head">
          <div>
            <div class="eyebrow">Сравнение</div>
            <h2 class="card-title">Сравнение месяцев</h2>
            <div class="card-subtitle">Основной месяц vs месяц сравнения</div>
          </div>
          <div class="card-actions">
            <button class="ghost" id="compareCopyBtn" type="button">Скопировать TSV</button>
            <div class="copy-status" id="compareCopyStatus"></div>
          </div>
        </div>
        <div id="compareTableContainer" class="d1-scroll">
          <div class="empty-state">Загрузка данных…</div>
        </div>
      </section>

      <section class="cuteam-card">
        <div class="card-head">
          <div>
            <div class="eyebrow">Годовая сводка</div>
            <h2 class="card-title">План / факт по месяцам</h2>
            <div class="card-subtitle">Ключевые направления по годам и месяцам</div>
          </div>
          <div class="card-actions">
            <button class="ghost" id="yearCopyBtn" type="button">Скопировать TSV</button>
            <div class="copy-status" id="yearCopyStatus"></div>
          </div>
        </div>
        <div id="yearTableContainer" class="d1-scroll">
          <div class="empty-state">Загрузка данных…</div>
        </div>
      </section>

      <div class="section-divider"></div>

      <section class="cuteam-card" id="overviewSection">
        <div class="card-head">
          <div>
            <div class="eyebrow">NEW Overview</div>
            <h2 class="card-title">Главный управленческий дашборд</h2>
            <div class="card-subtitle">KPI и быстрые ответы на ключевые вопросы</div>
          </div>
        </div>
        <div class="kpi-grid" id="overviewKpis"></div>
        <div class="overview-notes" id="overviewNotes"></div>
      </section>

      <section class="cuteam-card" id="revenueSection">
        <div class="card-head">
          <div>
            <div class="eyebrow">Дашборд 2</div>
            <h2 class="card-title">Доходы в целом</h2>
            <div class="card-subtitle">Динамика выручки и сравнение периодов</div>
          </div>
        </div>
        <div class="dashboard-grid">
          <div class="chart-card" id="revenueDailyChart"></div>
          <div class="chart-card" id="revenueWeeklyChart"></div>
          <div class="chart-card" id="revenueMonthlyChart"></div>
        </div>
        <div class="table-wrap" id="revenueCompareTable"></div>
        <div class="table-wrap" id="revenuePeriodsTable"></div>
      </section>

      <section class="cuteam-card" id="coworkingSection">
        <div class="card-head">
          <div>
            <div class="eyebrow">Дашборд 3</div>
            <h2 class="card-title">Коворкинг: доходы по направлениям</h2>
            <div class="card-subtitle">Динамика по неделям и ratio Лаборатория/Аренда</div>
          </div>
        </div>
        <div class="kpi-grid" id="coworkingCards"></div>
        <div class="dashboard-grid">
          <div class="chart-card" id="coworkingLineChart"></div>
          <div class="chart-card" id="coworkingRatioChart"></div>
        </div>
      </section>

      <section class="cuteam-card" id="coffeeMainSection">
        <div class="card-head">
          <div>
            <div class="eyebrow">Дашборд 4</div>
            <h2 class="card-title">Кофейня: основные показатели</h2>
            <div class="card-subtitle">Выручка, чеки, средний чек</div>
          </div>
        </div>
        <div class="kpi-grid" id="coffeeMainCards"></div>
        <div class="chart-card" id="coffeeMainChart"></div>
      </section>

      <section class="cuteam-card" id="coffeeStructureSection">
        <div class="card-head">
          <div>
            <div class="eyebrow">Дашборд 5</div>
            <h2 class="card-title">Кофейня: структура продаж</h2>
            <div class="card-subtitle">Еда и напитки по неделям</div>
          </div>
        </div>
        <div class="dashboard-grid">
          <div class="chart-card" id="coffeeFoodStack"></div>
          <div class="chart-card" id="coffeeDrinkStack"></div>
        </div>
      </section>

      <section class="cuteam-card" id="loadSection">
        <div class="card-head">
          <div>
            <div class="eyebrow">Дашборд 6</div>
            <h2 class="card-title">Загрузка и эффективность</h2>
            <div class="card-subtitle">Загрузка vs выручка</div>
          </div>
        </div>
        <div class="kpi-grid" id="loadCards"></div>
        <div class="dashboard-grid">
          <div class="chart-card" id="loadLineChart"></div>
          <div class="chart-card" id="loadScatterOpen"></div>
          <div class="chart-card" id="loadScatterCoffee"></div>
        </div>
      </section>

      <section class="cuteam-card" id="writeoffSection">
        <div class="card-head">
          <div>
            <div class="eyebrow">Дашборд 7</div>
            <h2 class="card-title">Списания и порча</h2>
            <div class="card-subtitle">Порча и writeoff rate</div>
          </div>
        </div>
        <div class="chart-card" id="writeoffChart"></div>
        <div class="table-wrap" id="writeoffStats"></div>
      </section>

      <section class="cuteam-card" id="cashSection">
        <div class="card-head">
          <div>
            <div class="eyebrow">Дашборд 8</div>
            <h2 class="card-title">Деньги и касса</h2>
            <div class="card-subtitle">Наличные/безналичные, кассовые расхождения</div>
          </div>
        </div>
        <div class="dashboard-grid">
          <div class="chart-card" id="cashLineChart"></div>
          <div class="chart-card" id="cashBarsChart"></div>
        </div>
        <div class="table-wrap" id="cashControlTable"></div>
      </section>

      <section class="cuteam-card" id="expenseSection">
        <div class="card-head">
          <div>
            <div class="eyebrow">Дашборд 9</div>
            <h2 class="card-title">Расходы</h2>
            <div class="card-subtitle">Структура и доля от выручки</div>
          </div>
        </div>
        <div class="dashboard-grid">
          <div class="chart-card" id="expenseLineChart"></div>
          <div class="chart-card" id="expenseStackChart"></div>
          <div class="chart-card" id="expenseRatioChart"></div>
        </div>
      </section>

      <section class="cuteam-card" id="profitSection">
        <div class="card-head">
          <div>
            <div class="eyebrow">Дашборд 10</div>
            <h2 class="card-title">Прибыль и рентабельность</h2>
            <div class="card-subtitle">Operating profit и маржа</div>
          </div>
        </div>
        <div class="dashboard-grid">
          <div class="chart-card" id="profitChart"></div>
          <div class="chart-card" id="marginChart"></div>
        </div>
      </section>

      <section class="cuteam-card" id="signalsSection">
        <div class="card-head">
          <div>
            <div class="eyebrow">Дашборд 11</div>
            <h2 class="card-title">Сигналы и контроль</h2>
            <div class="card-subtitle">Автоматические сигналы по KPI</div>
          </div>
        </div>
        <div class="table-wrap" id="signalsTable"></div>
      </section>

    </div>

    <script>
      const state = {
        branchCode: null,
        month: null,
        summaryMonth: null,
        compareMonth: null,
        scale: "weeks",
        data: null,
        rawData: null,
        compareData: null,
        yearData: null,
        overviewData: null,
      };

      const branchSelect = document.getElementById("branchSelect");
      const monthSelect = document.getElementById("monthSelect");
      const compareMonthSelect = document.getElementById("compareMonthSelect");
      const tableContainer = document.getElementById("tableContainer");
      const rawTableContainer = document.getElementById("rawTableContainer");
      const rawCopyBtn = document.getElementById("rawCopyBtn");
      const rawCopyStatus = document.getElementById("rawCopyStatus");
      const summaryCopyBtn = document.getElementById("summaryCopyBtn");
      const summaryCopyStatus = document.getElementById("summaryCopyStatus");
      const compareTableContainer = document.getElementById("compareTableContainer");
      const compareCopyBtn = document.getElementById("compareCopyBtn");
      const compareCopyStatus = document.getElementById("compareCopyStatus");
      const yearTableContainer = document.getElementById("yearTableContainer");
      const yearCopyBtn = document.getElementById("yearCopyBtn");
      const yearCopyStatus = document.getElementById("yearCopyStatus");
      const planStatus = document.getElementById("planStatus");
      const branchField = document.getElementById("branchField");
      const overviewKpis = document.getElementById("overviewKpis");
      const overviewNotes = document.getElementById("overviewNotes");
      const revenueDailyChart = document.getElementById("revenueDailyChart");
      const revenueWeeklyChart = document.getElementById("revenueWeeklyChart");
      const revenueMonthlyChart = document.getElementById("revenueMonthlyChart");
      const revenueCompareTable = document.getElementById("revenueCompareTable");
      const revenuePeriodsTable = document.getElementById("revenuePeriodsTable");
      const coworkingCards = document.getElementById("coworkingCards");
      const coworkingLineChart = document.getElementById("coworkingLineChart");
      const coworkingRatioChart = document.getElementById("coworkingRatioChart");
      const coffeeMainCards = document.getElementById("coffeeMainCards");
      const coffeeMainChart = document.getElementById("coffeeMainChart");
      const coffeeFoodStack = document.getElementById("coffeeFoodStack");
      const coffeeDrinkStack = document.getElementById("coffeeDrinkStack");
      const loadCards = document.getElementById("loadCards");
      const loadLineChart = document.getElementById("loadLineChart");
      const loadScatterOpen = document.getElementById("loadScatterOpen");
      const loadScatterCoffee = document.getElementById("loadScatterCoffee");
      const writeoffChart = document.getElementById("writeoffChart");
      const writeoffStats = document.getElementById("writeoffStats");
      const cashLineChart = document.getElementById("cashLineChart");
      const cashBarsChart = document.getElementById("cashBarsChart");
      const cashControlTable = document.getElementById("cashControlTable");
      const expenseLineChart = document.getElementById("expenseLineChart");
      const expenseStackChart = document.getElementById("expenseStackChart");
      const expenseRatioChart = document.getElementById("expenseRatioChart");
      const profitChart = document.getElementById("profitChart");
      const marginChart = document.getElementById("marginChart");
      const signalsTable = document.getElementById("signalsTable");


      function formatNumber(value, decimals = 0) {
        return new Intl.NumberFormat("ru-RU", {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals,
        }).format(value);
      }

      function valueOrZero(value) {
        if (value === null || value === undefined || Number.isNaN(value)) return 0;
        return value;
      }

      function isZeroLike(value) {
        return valueOrZero(value) === 0;
      }

      function applyZeroClass(element, value) {
        if (isZeroLike(value)) element.classList.add("zero-value");
      }

      function formatValue(value, unit) {
        const safe = valueOrZero(value);
        if (unit === "pct") {
          return `${formatNumber(safe, 1)}%`;
        }
        if (unit === "ratio") {
          return formatNumber(safe, 2);
        }
        if (unit === "rub") {
          return formatNumber(safe, Math.abs(safe % 1) > 0.01 ? 2 : 0);
        }
        if (unit === "qty") {
          return formatNumber(safe, 0);
        }
        return formatNumber(safe, 0);
      }

      function formatRawValue(value) {
        const safe = valueOrZero(value);
        const decimals = Math.abs(safe % 1) > 0.01 ? 2 : 0;
        return formatNumber(safe, decimals);
      }

      function formatSigned(value) {
        const safe = valueOrZero(value);
        if (safe === 0) return "0";
        const sign = safe > 0 ? "+" : "-";
        return `${sign}${formatRawValue(Math.abs(safe))}`;
      }

      function formatSignedPercent(value) {
        const safe = valueOrZero(value);
        if (safe === 0) return "0%";
        const sign = safe > 0 ? "+" : "-";
        return `${sign}${formatNumber(Math.abs(safe), 1)}%`;
      }

      function formatPlanSummary(planPct, planDelta) {
        if (planPct === null || planPct === undefined) return "";
        const pct = `${formatNumber(planPct, 0)}%`;
        if (planDelta === null || planDelta === undefined) return pct;
        const delta = formatNumber(planDelta, Math.abs(planDelta % 1) > 0.01 ? 2 : 0);
        return `${pct} · ${delta}`;
      }

      function formatMonthLabel(isoMonth) {
        const [year, month] = isoMonth.split("-");
        const date = new Date(Number(year), Number(month) - 1, 1);
        return new Intl.DateTimeFormat("ru-RU", { month: "long", year: "numeric" }).format(date);
      }

      function setCopyStatus(message, isError = false) {
        rawCopyStatus.textContent = message || "";
        if (!message) return;
        rawCopyStatus.style.color = isError ? "#b2412e" : "#2f7d55";
        setTimeout(() => {
          if (rawCopyStatus.textContent === message) rawCopyStatus.textContent = "";
        }, 2400);
      }

      function tsvValue(value) {
        const safe = valueOrZero(value);
        return String(safe);
      }

      function buildRawTSV(data) {
        const days = data.days || [];
        const weeks = data.weeks || [];
        const metrics = data.metrics || [];

        const header = ["Показатель"];
        let weekIndex = 0;
        days.forEach((day, idx) => {
          header.push(String(day.day).padStart(2, "0"));
          if (weekIndex < weeks.length && idx === weeks[weekIndex].end_idx) {
            header.push("Итог нед.");
            weekIndex += 1;
          }
        });
        header.push("Итого месяц");

        const lines = [header.join("\t")];
        metrics.forEach((metric) => {
          const row = [metric.label];
          let idx = 0;
          weekIndex = 0;
          metric.values.forEach((value) => {
            row.push(tsvValue(value));
            if (weekIndex < weeks.length && idx === weeks[weekIndex].end_idx) {
              row.push(tsvValue(metric.week_totals[weekIndex]));
              weekIndex += 1;
            }
            idx += 1;
          });
          row.push(tsvValue(metric.month_total));
          lines.push(row.join("\t"));
        });
        return lines.join("\n");
      }

      async function copyRawTSV() {
        if (!state.rawData || !state.rawData.metrics || state.rawData.metrics.length === 0) {
          setCopyStatus("Нет данных для копирования", true);
          return;
        }
        const tsv = buildRawTSV(state.rawData);
        try {
          await navigator.clipboard.writeText(tsv);
          setCopyStatus("Скопировано");
        } catch (err) {
          try {
            const textarea = document.createElement("textarea");
            textarea.value = tsv;
            textarea.style.position = "fixed";
            textarea.style.opacity = "0";
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
            setCopyStatus("Скопировано");
          } catch (fallbackErr) {
            console.error(fallbackErr);
            setCopyStatus("Не удалось скопировать", true);
          }
        }
      }

      function buildSummaryTSV() {
        if (!state.data || !state.data.metrics) return "";
        const weeks = state.data.weeks || [];
        const weekLabels = state.data.week_labels || [];
        const metrics = state.data.metrics || [];

        const header = ["Показатель", "Ед."];
        if (weekLabels.length) {
          weekLabels.forEach((label) => {
            header.push(label);
          });
        } else {
          weeks.forEach((week, idx) => {
            const start = week.start.slice(8, 10);
            const end = week.end.slice(8, 10);
            header.push(`Нед ${idx + 1} (${start}-${end})`);
          });
        }
        header.push("Итого месяц");
        header.push("План");
        header.push("Прогноз");
        header.push("%");

        const lines = [header.join("\t")];
        metrics.forEach((metric) => {
          const row = [metric.label, metric.unit];
          metric.week_totals.forEach((value) => {
            row.push(tsvValue(value));
          });
          row.push(tsvValue(metric.month_total));
          row.push(tsvValue(metric.plan));
          row.push(tsvValue(metric.forecast));
          row.push(tsvValue(metric.forecast_pct));
          lines.push(row.join("\t"));
        });
        return lines.join("\n");
      }

      async function copySummaryTSV() {
        const tsv = buildSummaryTSV();
        if (!tsv) {
          summaryCopyStatus.textContent = "Нет данных";
          return;
        }
        try {
          await navigator.clipboard.writeText(tsv);
          summaryCopyStatus.textContent = "Скопировано";
          setTimeout(() => (summaryCopyStatus.textContent = ""), 2400);
        } catch (err) {
          summaryCopyStatus.textContent = "Не удалось";
          setTimeout(() => (summaryCopyStatus.textContent = ""), 2400);
        }
      }

      const METRIC_LABELS = {
        revenue_total: "Выручка",
        revenue_cashless: "Безналичные",
        revenue_cash: "Наличные",
        cash_balance_end_day: "Остаток на конец дня",
        revenue_open_space: "Аренда",
        revenue_cabinets: "Кабинеты",
        revenue_lecture: "Лекторий",
        revenue_lab: "Лаборатория",
        revenue_retail: "Ритейл",
        revenue_salon: "Услуги салона",
        load_percent: "Загрузка",
        coffee_revenue_total: "Кофейня",
        coffee_checks: "Чеки",
        avg_check: "Средний чек",
        sold_food_total: "Еда всего",
        revenue_desserts: "Десерты",
        revenue_food_breakfast: "Завтраки",
        revenue_food_lunch: "Обеды",
        revenue_food_croissants: "Круассаны",
        revenue_food_salads: "Салаты",
        revenue_food_sandwiches: "Сэндвичи",
        revenue_drinks_total: "Напитки всего",
        revenue_coffee: "Кофе",
        revenue_coffee_hot: "Кофе/чай/какао",
        revenue_drinks_cold: "Напитки ритейл",
        revenue_drinks_seasonal: "Сезонные напитки",
        written_off_food_total: "Порча",
        writeoff_rate: "Доля порчи",
        writeoff_rate_full: "Доля порчи",
        withdrawals_total: "Изъятия",
        deposit_total: "Внесения",
        expense_cleaning_salary: "ЗП клининг",
        expense_staff_salary: "ЗП персонал",
        expense_maintenance: "Текущий ремонт",
        expense_facility: "Содержание помещения",
        expense_delivery_taxi: "Курьер, доставка, такси",
        expense_food_purchase: "Закупка продуктов",
        expense_marketing: "Маркетинг",
        expense_hiring: "Найм",
        expense_cash_collection: "Инкассация",
        expense_other: "Прочее",
        total_expenses: "Расходы всего",
        expense_ratio: "Доля расходов",
        gross_profit: "Валовая прибыль",
        operating_profit: "Опер. прибыль",
        operating_margin: "Опер. маржа",
        coworking_total: "Коворкинг всего",
        lab_to_open_space_ratio: "Лаборатория / Аренда",
        revenue_per_load: "Выручка на % загрузки",
        coffee_revenue_per_load: "Кофейня на % загрузки",
      };

      const METRIC_UNITS = {
        revenue_total: "rub",
        revenue_cashless: "rub",
        revenue_cash: "rub",
        cash_balance_end_day: "rub",
        revenue_open_space: "rub",
        revenue_cabinets: "rub",
        revenue_lecture: "rub",
        revenue_lab: "rub",
        revenue_retail: "rub",
        revenue_salon: "rub",
        load_percent: "pct",
        coffee_revenue_total: "rub",
        coffee_checks: "qty",
        avg_check: "rub",
        sold_food_total: "rub",
        revenue_desserts: "rub",
        revenue_food_breakfast: "rub",
        revenue_food_lunch: "rub",
        revenue_food_croissants: "rub",
        revenue_food_salads: "rub",
        revenue_food_sandwiches: "rub",
        revenue_drinks_total: "rub",
        revenue_coffee: "rub",
        revenue_coffee_hot: "rub",
        revenue_drinks_cold: "rub",
        revenue_drinks_seasonal: "rub",
        written_off_food_total: "rub",
        writeoff_rate: "pct_ratio",
        writeoff_rate_full: "pct_ratio",
        withdrawals_total: "rub",
        deposit_total: "rub",
        expense_cleaning_salary: "rub",
        expense_staff_salary: "rub",
        expense_maintenance: "rub",
        expense_facility: "rub",
        expense_delivery_taxi: "rub",
        expense_food_purchase: "rub",
        expense_marketing: "rub",
        expense_hiring: "rub",
        expense_cash_collection: "rub",
        expense_other: "rub",
        total_expenses: "rub",
        expense_ratio: "pct_ratio",
        gross_profit: "rub",
        operating_profit: "rub",
        operating_margin: "pct_ratio",
        coworking_total: "rub",
        lab_to_open_space_ratio: "ratio",
        revenue_per_load: "rub",
        coffee_revenue_per_load: "rub",
      };

      const COWORKING_CODES = [
        "revenue_open_space",
        "revenue_cabinets",
        "revenue_lecture",
        "revenue_lab",
        "revenue_retail",
        "revenue_salon",
      ];

      const FOOD_CODES = [
        "sold_food_total",
        "revenue_desserts",
        "revenue_food_breakfast",
        "revenue_food_lunch",
        "revenue_food_croissants",
        "revenue_food_salads",
        "revenue_food_sandwiches",
      ];

      const DRINK_CODES = [
        "revenue_drinks_total",
        "revenue_coffee",
        "revenue_coffee_hot",
        "revenue_drinks_cold",
        "revenue_drinks_seasonal",
      ];

      const EXPENSE_CODES = [
        "expense_cleaning_salary",
        "expense_staff_salary",
        "expense_maintenance",
        "expense_facility",
        "expense_delivery_taxi",
        "expense_food_purchase",
        "expense_marketing",
        "expense_hiring",
        "expense_cash_collection",
        "expense_other",
      ];

      const PALETTE = [
        "#d99a83",
        "#f7c976",
        "#e9bda6",
        "#c2d6c4",
        "#f1d0c2",
        "#3a3a3a",
        "#a9836f",
      ];

      function getMetricLabel(code) {
        return METRIC_LABELS[code] || code;
      }

      function getMetricUnit(code) {
        return METRIC_UNITS[code] || "rub";
      }

      function formatAuto(value, unit) {
        const safe = valueOrZero(value);
        if (unit === "pct_ratio") {
          return `${formatNumber(safe * 100, 1)}%`;
        }
        if (unit === "pct") {
          return `${formatNumber(safe, 1)}%`;
        }
        if (unit === "ratio") {
          return formatNumber(safe, 2);
        }
        if (unit === "qty") {
          return formatNumber(safe, 0);
        }
        return formatNumber(safe, Math.abs(safe % 1) > 0.01 ? 2 : 0);
      }

      function formatCompact(value, unit) {
        const safe = valueOrZero(value);
        if (unit && unit !== "rub") {
          return formatAuto(safe, unit);
        }
        const abs = Math.abs(safe);
        let scaled = safe;
        let suffix = "";
        if (abs >= 1000000) {
          scaled = safe / 1000000;
          suffix = "M";
        } else if (abs >= 1000) {
          scaled = safe / 1000;
          suffix = "k";
        }
        return `${formatNumber(scaled, abs >= 1000000 ? 2 : 1)}${suffix}`;
      }

      function setCellValue(cell, value, formatter = formatRawValue, highlightZero = false) {
        const safe = valueOrZero(value);
        cell.textContent = formatter(safe);
        if (highlightZero) {
          applyZeroClass(cell, safe);
        }
      }

      function buildValueCell(value, formatter) {
        const safe = valueOrZero(value);
        return {
          text: formatter(safe),
          className: safe === 0 ? "zero-value" : "",
        };
      }

      function computeDelta(current, prev) {
        if (current === null || current === undefined || prev === null || prev === undefined) {
          return { delta: null, pct: null };
        }
        const delta = current - prev;
        const pct = prev !== 0 ? (delta / prev) * 100 : null;
        return { delta, pct };
      }

      function deltaClass(deltaValue) {
        if (deltaValue === null || deltaValue === undefined) return "zero-value";
        if (deltaValue === 0) return "zero-value";
        return deltaValue > 0 ? "delta-positive" : "delta-negative";
      }

      function buildDeltaLine(label, deltaObj) {
        const line = document.createElement("div");
        line.className = "kpi-sub";
        if (!deltaObj || deltaObj.delta === null || deltaObj.delta === undefined) {
          line.textContent = `${label}: 0`;
          line.classList.add("zero-value");
          return line;
        }
        const valueSpan = document.createElement("span");
        valueSpan.textContent = `${formatSigned(deltaObj.delta)} ${
          deltaObj.pct !== null && deltaObj.pct !== undefined ? `(${formatSignedPercent(deltaObj.pct)})` : ""
        }`;
        valueSpan.className = deltaClass(deltaObj.delta);
        line.textContent = `${label}: `;
        line.appendChild(valueSpan);
        return line;
      }

      function createKpiTile({ title, value, unit, lines }) {
        const tile = document.createElement("div");
        tile.className = "kpi-tile";
        const titleEl = document.createElement("div");
        titleEl.className = "kpi-title";
        titleEl.textContent = title;
        const valueEl = document.createElement("div");
        valueEl.className = "kpi-value";
        const safeValue = valueOrZero(value);
        valueEl.textContent = formatCompact(safeValue, unit);
        applyZeroClass(valueEl, safeValue);
        tile.appendChild(titleEl);
        tile.appendChild(valueEl);
        (lines || []).forEach((line) => {
          if (!line) return;
          if (typeof line === "string") {
            const div = document.createElement("div");
            div.className = "kpi-sub";
            div.textContent = line;
            tile.appendChild(div);
          } else {
            tile.appendChild(line);
          }
        });
        return tile;
      }

      function renderKpiGrid(container, tiles) {
        container.innerHTML = "";
        tiles.forEach((tile) => container.appendChild(tile));
      }

      function renderEmpty(container, message) {
        if (!container) return;
        container.innerHTML = `<div class="empty-state">${message}</div>`;
      }

      function renderChartCard(container, title, content, subtitle) {
        container.innerHTML = "";
        const titleEl = document.createElement("div");
        titleEl.className = "chart-title";
        titleEl.textContent = title;
        container.appendChild(titleEl);
        if (subtitle) {
          const subtitleEl = document.createElement("div");
          subtitleEl.className = "kpi-sub";
          subtitleEl.textContent = subtitle;
          container.appendChild(subtitleEl);
        }
        if (content) {
          container.appendChild(content);
        } else {
          renderEmpty(container, "Нет данных");
        }
      }

      function createSparkline(values, color = "#d99a83") {
        const numeric = (values || []).filter((v) => typeof v === "number" && !Number.isNaN(v));
        if (numeric.length === 0) {
          const div = document.createElement("div");
          div.className = "empty-state";
          div.textContent = "Нет данных";
          return div;
        }
        const min = Math.min(...numeric);
        const max = Math.max(...numeric);
        const range = max - min || 1;
        const width = 100;
        const height = 40;
        const points = (values || []).map((value, idx) => {
          const safe = typeof value === "number" ? value : min;
          const x = values.length === 1 ? width / 2 : (idx / (values.length - 1)) * width;
          const y = height - ((safe - min) / range) * height;
          return `${x},${y}`;
        });
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.setAttribute("class", "sparkline");
        const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
        polyline.setAttribute("fill", "none");
        polyline.setAttribute("stroke", color);
        polyline.setAttribute("stroke-width", "2");
        polyline.setAttribute("points", points.join(" "));
        svg.appendChild(polyline);
        return svg;
      }

      function buildLegend(items) {
        const legend = document.createElement("div");
        legend.className = "legend-row";
        items.forEach((item) => {
          const pill = document.createElement("span");
          pill.className = "legend-pill";
          const dot = document.createElement("span");
          dot.className = "pill-dot";
          dot.style.background = item.color;
          const text = document.createElement("span");
          text.textContent = item.label;
          pill.appendChild(dot);
          pill.appendChild(text);
          legend.appendChild(pill);
        });
        return legend;
      }

      function createMultiLine(series) {
        const usable = series.filter((s) => (s.values || []).some((v) => typeof v === "number"));
        if (usable.length === 0) {
          const div = document.createElement("div");
          div.className = "empty-state";
          div.textContent = "Нет данных";
          return div;
        }
        const width = 100;
        const height = 48;
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.setAttribute("class", "sparkline");
        usable.forEach((item) => {
          const values = item.values || [];
          const numeric = values.filter((v) => typeof v === "number" && !Number.isNaN(v));
          if (numeric.length === 0) return;
          const min = Math.min(...numeric);
          const max = Math.max(...numeric);
          const range = max - min || 1;
          const points = values.map((value, idx) => {
            const safe = typeof value === "number" ? value : min;
            const x = values.length === 1 ? width / 2 : (idx / (values.length - 1)) * width;
            const y = height - ((safe - min) / range) * height;
            return `${x},${y}`;
          });
          const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
          polyline.setAttribute("fill", "none");
          polyline.setAttribute("stroke", item.color || "#d99a83");
          polyline.setAttribute("stroke-width", "2");
          polyline.setAttribute("points", points.join(" "));
          svg.appendChild(polyline);
        });
        const wrapper = document.createElement("div");
        wrapper.appendChild(svg);
        wrapper.appendChild(
          buildLegend(
            usable.map((item) => ({
              label: item.label,
              color: item.color || "#d99a83",
            }))
          )
        );
        return wrapper;
      }

      function createScatter(points, color = "#d99a83") {
        if (!points || points.length === 0) {
          const div = document.createElement("div");
          div.className = "empty-state";
          div.textContent = "Нет данных";
          return div;
        }
        const xs = points.map((p) => p.x).filter((v) => typeof v === "number");
        const ys = points.map((p) => p.y).filter((v) => typeof v === "number");
        if (!xs.length || !ys.length) {
          const div = document.createElement("div");
          div.className = "empty-state";
          div.textContent = "Нет данных";
          return div;
        }
        const minX = Math.min(...xs);
        const maxX = Math.max(...xs);
        const minY = Math.min(...ys);
        const maxY = Math.max(...ys);
        const rangeX = maxX - minX || 1;
        const rangeY = maxY - minY || 1;
        const width = 100;
        const height = 80;
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.setAttribute("class", "scatter");
        points.forEach((point) => {
          if (typeof point.x !== "number" || typeof point.y !== "number") return;
          const cx = ((point.x - minX) / rangeX) * width;
          const cy = height - ((point.y - minY) / rangeY) * height;
          const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          circle.setAttribute("cx", cx);
          circle.setAttribute("cy", cy);
          circle.setAttribute("r", "3");
          circle.setAttribute("fill", color);
          svg.appendChild(circle);
        });
        return svg;
      }

      function sumValues(values) {
        return (values || []).reduce(
          (total, value) => total + (typeof value === "number" ? value : 0),
          0
        );
      }

      function formatDayShort(iso) {
        if (!iso) return "";
        const date = new Date(iso);
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        return `${day}.${month}`;
      }

      function formatWeekLabel(week) {
        if (!week) return "";
        return `${formatDayShort(week.start)}-${formatDayShort(week.end)}`;
      }

      function createStackedRows(weeks, valuesMap, codes, title) {
        const wrapper = document.createElement("div");
        if (title) {
          const titleEl = document.createElement("div");
          titleEl.className = "chart-title";
          titleEl.textContent = title;
          wrapper.appendChild(titleEl);
        }
        if (!weeks || weeks.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty-state";
          empty.textContent = "Нет данных";
          wrapper.appendChild(empty);
          return wrapper;
        }
        weeks.forEach((week, idx) => {
          const row = document.createElement("div");
          row.className = "stack-row";
          const label = document.createElement("div");
          label.className = "stack-label";
          label.textContent = formatWeekLabel(week);
          row.appendChild(label);
          const bar = document.createElement("div");
          bar.className = "stack-bar";
          const totals = codes.map((code) => (valuesMap[code] || [])[idx]);
          const total = sumValues(totals);
          if (total > 0) {
            totals.forEach((value, codeIdx) => {
              const segment = document.createElement("div");
              segment.style.width = `${(value / total) * 100}%`;
              segment.style.background = PALETTE[codeIdx % PALETTE.length];
              bar.appendChild(segment);
            });
          }
          row.appendChild(bar);
          wrapper.appendChild(row);
        });
        wrapper.appendChild(
          buildLegend(
            codes.map((code, idx) => ({
              label: getMetricLabel(code),
              color: PALETTE[idx % PALETTE.length],
            }))
          )
        );
        return wrapper;
      }

      function buildMiniTable(headers, rows) {
        const table = document.createElement("table");
        table.className = "mini-table";
        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        headers.forEach((header) => {
          const th = document.createElement("th");
          th.textContent = header;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);
        const tbody = document.createElement("tbody");
        rows.forEach((row) => {
          const tr = document.createElement("tr");
          row.forEach((cell, idx) => {
            const td = document.createElement(idx === 0 ? "th" : "td");
            if (cell && typeof cell === "object") {
              td.textContent = cell.text ?? "";
              if (cell.className) {
                td.classList.add(cell.className);
              }
            } else {
              td.textContent = cell ?? "";
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        return table;
      }

      function renderOverview(data) {
        if (!data) {
          renderEmpty(overviewKpis, "Нет данных");
          return;
        }
        const period = data.period_values || {};
        const monthValues = period.month || {};
        const prevMonthValues = period.prev_month || {};
        const yoyMonthValues = period.yoy_month || {};
        const weekValues = period.week || {};
        const prevWeekValues = period.prev_week || {};
        const yoyWeekValues = period.yoy_week || {};

        const tiles = [
          createKpiTile({
            title: "Выручка всего",
            value: monthValues.revenue_total,
            unit: getMetricUnit("revenue_total"),
            lines: [
              buildDeltaLine("Δ неделя", computeDelta(weekValues.revenue_total, prevWeekValues.revenue_total)),
              buildDeltaLine("Δ год", computeDelta(monthValues.revenue_total, yoyMonthValues.revenue_total)),
            ],
          }),
          createKpiTile({
            title: "Коворкинг всего",
            value: monthValues.coworking_total,
            unit: getMetricUnit("coworking_total"),
            lines: [
              `Доля: ${formatAuto(
                monthValues.coworking_total && monthValues.revenue_total
                  ? monthValues.coworking_total / monthValues.revenue_total
                  : null,
                "pct_ratio"
              )}`,
            ],
          }),
          createKpiTile({
            title: "Кофейня всего",
            value: monthValues.coffee_revenue_total,
            unit: getMetricUnit("coffee_revenue_total"),
            lines: [
              `Чеки: ${formatAuto(monthValues.coffee_checks, getMetricUnit("coffee_checks"))}`,
              `Средний чек: ${formatAuto(monthValues.avg_check, getMetricUnit("avg_check"))}`,
            ],
          }),
          createKpiTile({
            title: "Загрузка",
            value: monthValues.load_percent,
            unit: getMetricUnit("load_percent"),
            lines: ["Среднее за месяц"],
          }),
          createKpiTile({
            title: "Порча",
            value: monthValues.written_off_food_total,
            unit: getMetricUnit("written_off_food_total"),
            lines: [
              `Доля: ${formatAuto(monthValues.writeoff_rate, getMetricUnit("writeoff_rate"))}`,
            ],
          }),
        ];
        renderKpiGrid(overviewKpis, tiles);

        overviewNotes.innerHTML = "";
        const notesGrid = document.createElement("div");
        notesGrid.className = "overview-grid";
        const notes = [
          {
            title: "Сколько заработали",
            text: `Выручка за месяц: ${formatAuto(monthValues.revenue_total, "rub")}`,
          },
          {
            title: "Где заработали",
            text: `Коворкинг: ${formatAuto(monthValues.coworking_total, "rub")}, кофейня: ${formatAuto(
              monthValues.coffee_revenue_total,
              "rub"
            )}`,
          },
          {
            title: "Где рост",
            text: `Δ месяц: ${formatSigned(
              computeDelta(monthValues.revenue_total, prevMonthValues.revenue_total).delta
            )}`,
          },
          {
            title: "Где риск",
            text: data.cash_control && data.cash_control.length
              ? `Расхождения в кассе: ${data.cash_control.length}`
              : "Касса без расхождений",
          },
          {
            title: "Где проблема",
            text: `Порча: ${formatAuto(monthValues.writeoff_rate, "pct_ratio")}`,
          },
        ];
        notes.forEach((note) => {
          const item = document.createElement("div");
          item.className = "overview-item";
          const h3 = document.createElement("h3");
          h3.textContent = note.title;
          const p = document.createElement("p");
          p.textContent = note.text;
          item.appendChild(h3);
          item.appendChild(p);
          notesGrid.appendChild(item);
        });
        overviewNotes.appendChild(notesGrid);

        const daily = data.daily || {};
        const weekly = data.weekly || {};
        const monthly = data.monthly || {};
        const weeklyValues = weekly.values || {};
        const dailyValues = daily.values || {};
        const monthlyValues = monthly.values || {};
        const weeks = weekly.weeks || [];

        renderChartCard(
          revenueDailyChart,
          "Выручка по дням",
          createSparkline(dailyValues.revenue_total || [], "#d99a83")
        );
        renderChartCard(
          revenueWeeklyChart,
          "Выручка по неделям",
          createSparkline(weeklyValues.revenue_total || [], "#3a3a3a")
        );
        renderChartCard(
          revenueMonthlyChart,
          "Выручка по месяцам",
          createSparkline(monthlyValues.revenue_total || [], "#a9836f")
        );

        if (revenueCompareTable) {
          const compareRows = (data.revenue_compare || []).map((row) => {
            const unit = getMetricUnit(row.code);
            const deltaSafe = valueOrZero(row.delta_pct);
            const deltaClassName = deltaClass(deltaSafe);
            return [
              { text: getMetricLabel(row.code) },
              buildValueCell(row.current, (value) => formatAuto(value, unit)),
              buildValueCell(row.previous, (value) => formatAuto(value, unit)),
              buildValueCell(row.yoy, (value) => formatAuto(value, unit)),
              {
                text: formatSignedPercent(deltaSafe),
                className: deltaClassName,
              },
            ];
          });
          const header = [
            "Показатель",
            `Текущий (${formatMonthLabel(data.month)})`,
            "Прошлый месяц",
            "YoY",
            "Δ%",
          ];
          revenueCompareTable.innerHTML = "";
          revenueCompareTable.appendChild(buildMiniTable(header, compareRows));
        }

        if (revenuePeriodsTable) {
          const periodRows = (data.period_compare || []).map((row) => {
            return [
              { text: row.label },
              buildValueCell(row.current, (value) => formatAuto(value, "rub")),
              buildValueCell(row.previous, (value) => formatAuto(value, "rub")),
              buildValueCell(row.yoy, (value) => formatAuto(value, "rub")),
              buildValueCell(row.best, (value) => formatAuto(value, "rub")),
            ];
          });
          const header = ["Период", "Текущий", "Прошлый", "YoY", "Лучший"];
          revenuePeriodsTable.innerHTML = "";
          revenuePeriodsTable.appendChild(buildMiniTable(header, periodRows));
        }

        if (coworkingCards) {
          const cards = COWORKING_CODES.map((code) =>
            createKpiTile({
              title: getMetricLabel(code),
              value: weekValues[code],
              unit: getMetricUnit(code),
              lines: [
                buildDeltaLine("Δ WoW", computeDelta(weekValues[code], prevWeekValues[code])),
                buildDeltaLine("Δ YoY", computeDelta(weekValues[code], yoyWeekValues[code])),
              ],
            })
          );
          coworkingCards.innerHTML = "";
          cards.forEach((card) => coworkingCards.appendChild(card));
        }

        if (coworkingLineChart) {
          const series = COWORKING_CODES.map((code, idx) => ({
            label: getMetricLabel(code),
            values: weeklyValues[code] || [],
            color: PALETTE[idx % PALETTE.length],
          }));
          renderChartCard(coworkingLineChart, "Направления по неделям", createMultiLine(series));
        }

        if (coworkingRatioChart) {
          renderChartCard(
            coworkingRatioChart,
            "Лаборатория / Аренда",
            createSparkline(weeklyValues.lab_to_open_space_ratio || [], "#8b1e1e")
          );
        }

        if (coffeeMainCards) {
          const coffeeCards = [
            { code: "coffee_revenue_total", label: "Выручка" },
            { code: "coffee_checks", label: "Чеки" },
            { code: "avg_check", label: "Средний чек" },
          ].map((item) =>
            createKpiTile({
              title: item.label,
              value: weekValues[item.code],
              unit: getMetricUnit(item.code),
              lines: [
                buildDeltaLine("Δ WoW", computeDelta(weekValues[item.code], prevWeekValues[item.code])),
                buildDeltaLine("Δ YoY", computeDelta(weekValues[item.code], yoyWeekValues[item.code])),
              ],
            })
          );
          coffeeMainCards.innerHTML = "";
          coffeeCards.forEach((card) => coffeeMainCards.appendChild(card));
        }

        if (coffeeMainChart) {
          const series = [
            {
              label: "Выручка",
              values: weeklyValues.coffee_revenue_total || [],
              color: "#d99a83",
            },
            {
              label: "Чеки",
              values: weeklyValues.coffee_checks || [],
              color: "#3a3a3a",
            },
            {
              label: "Средний чек",
              values: weeklyValues.avg_check || [],
              color: "#a9836f",
            },
          ];
          renderChartCard(coffeeMainChart, "Динамика кофе", createMultiLine(series));
        }

        if (coffeeFoodStack) {
          coffeeFoodStack.innerHTML = "";
          coffeeFoodStack.appendChild(
            createStackedRows(weeks, weeklyValues, FOOD_CODES, "Еда: структура по неделям")
          );
        }

        if (coffeeDrinkStack) {
          coffeeDrinkStack.innerHTML = "";
          coffeeDrinkStack.appendChild(
            createStackedRows(weeks, weeklyValues, DRINK_CODES, "Напитки: структура по неделям")
          );
        }

        if (loadCards) {
          const loadTiles = [
            createKpiTile({
              title: "Загрузка",
              value: monthValues.load_percent,
              unit: getMetricUnit("load_percent"),
              lines: ["Среднее за месяц"],
            }),
            createKpiTile({
              title: "Выручка / %",
              value: monthValues.revenue_per_load,
              unit: getMetricUnit("revenue_per_load"),
              lines: ["Коворкинг"],
            }),
            createKpiTile({
              title: "Кофейня / %",
              value: monthValues.coffee_revenue_per_load,
              unit: getMetricUnit("coffee_revenue_per_load"),
              lines: ["Кофейня"],
            }),
          ];
          loadCards.innerHTML = "";
          loadTiles.forEach((tile) => loadCards.appendChild(tile));
        }

        if (loadLineChart) {
          const series = [
            {
              label: "Загрузка",
              values: weeklyValues.load_percent || [],
              color: "#3a3a3a",
            },
            {
              label: "Аренда",
              values: weeklyValues.revenue_open_space || [],
              color: "#d99a83",
            },
          ];
          renderChartCard(loadLineChart, "Загрузка vs аренда", createMultiLine(series));
        }

        if (loadScatterOpen) {
          const points = (weeklyValues.load_percent || []).map((val, idx) => ({
            x: val,
            y: (weeklyValues.revenue_open_space || [])[idx],
          }));
          renderChartCard(loadScatterOpen, "Scatter: загрузка vs аренда", createScatter(points, "#d99a83"));
        }

        if (loadScatterCoffee) {
          const points = (weeklyValues.load_percent || []).map((val, idx) => ({
            x: val,
            y: (weeklyValues.coffee_revenue_total || [])[idx],
          }));
          renderChartCard(loadScatterCoffee, "Scatter: загрузка vs кофейня", createScatter(points, "#3a3a3a"));
        }

        if (writeoffChart) {
          const series = [
            {
              label: "Продажи еды",
              values: weeklyValues.sold_food_total || [],
              color: "#d99a83",
            },
            {
              label: "Порча",
              values: weeklyValues.written_off_food_total || [],
              color: "#8b1e1e",
            },
            {
              label: "Доля порчи",
              values: weeklyValues.writeoff_rate_full || [],
              color: "#3a3a3a",
            },
          ];
          renderChartCard(writeoffChart, "Списания и порча", createMultiLine(series));
        }

        if (writeoffStats) {
          const writeoffAvg = (weeklyValues.writeoff_rate_full || []).filter((v) => typeof v === "number");
          const avg = writeoffAvg.length ? writeoffAvg.reduce((a, b) => a + b, 0) / writeoffAvg.length : null;
          const rows = [
            [{ text: "Текущая доля" }, buildValueCell(weekValues.writeoff_rate_full, (value) => formatAuto(value, "pct_ratio"))],
            [{ text: "Среднее 8 недель" }, buildValueCell(avg, (value) => formatAuto(value, "pct_ratio"))],
            [{ text: "Норматив" }, { text: "10%" }],
          ];
          writeoffStats.innerHTML = "";
          writeoffStats.appendChild(buildMiniTable(["Показатель", "Значение"], rows));
        }

        if (cashLineChart) {
          const series = [
            {
              label: "Наличные",
              values: weeklyValues.revenue_cash || [],
              color: "#d99a83",
            },
            {
              label: "Безналичные",
              values: weeklyValues.revenue_cashless || [],
              color: "#3a3a3a",
            },
          ];
          renderChartCard(cashLineChart, "Динамика оплат", createMultiLine(series));
        }

        if (cashBarsChart) {
          cashBarsChart.innerHTML = "";
          cashBarsChart.appendChild(
            createStackedRows(weeks, weeklyValues, ["deposit_total", "withdrawals_total"], "Внесения и изъятия")
          );
        }

        if (cashControlTable) {
          const rows = (data.cash_control || []).slice(-10).map((item) => {
            const diffSafe = valueOrZero(item.diff);
            return [
              { text: item.date },
              buildValueCell(item.expected, (value) => formatAuto(value, "rub")),
              buildValueCell(item.actual, (value) => formatAuto(value, "rub")),
              { text: formatSigned(diffSafe), className: deltaClass(diffSafe) },
            ];
          });
          cashControlTable.innerHTML = "";
          cashControlTable.appendChild(buildMiniTable(["Дата", "Ожидалось", "Факт", "Δ"], rows));
        }

        if (expenseLineChart) {
          const series = [
            {
              label: "Расходы всего",
              values: weeklyValues.total_expenses || [],
              color: "#8b1e1e",
            },
          ];
          renderChartCard(expenseLineChart, "Расходы", createMultiLine(series));
        }

        if (expenseStackChart) {
          expenseStackChart.innerHTML = "";
          expenseStackChart.appendChild(
            createStackedRows(weeks, weeklyValues, EXPENSE_CODES, "Структура расходов")
          );
        }

        if (expenseRatioChart) {
          renderChartCard(
            expenseRatioChart,
            "Доля расходов от выручки",
            createSparkline(weeklyValues.expense_ratio || [], "#8b1e1e")
          );
        }

        if (profitChart) {
          renderChartCard(
            profitChart,
            "Операционная прибыль",
            createSparkline(weeklyValues.operating_profit || [], "#1f5e46")
          );
        }

        if (marginChart) {
          renderChartCard(
            marginChart,
            "Операционная маржа",
            createSparkline(weeklyValues.operating_margin || [], "#1f5e46")
          );
        }

        if (signalsTable) {
          const rows = (data.signals || []).map((signal) => {
            if (signal.message) {
              const countSafe = valueOrZero(signal.count);
              return [
                { text: signal.message },
                {
                  text: String(countSafe),
                  className: countSafe === 0 ? "zero-value" : "",
                },
                { text: "" },
                { text: "" },
                {
                  text: signal.status === "alert" ? "ALERT" : "OK",
                  className: signal.status === "alert" ? "delta-negative" : "delta-positive",
                },
              ];
            }
            const unit = getMetricUnit(signal.code);
            const deltaSafe = valueOrZero(signal.delta_pct);
            return [
              { text: getMetricLabel(signal.code) },
              buildValueCell(signal.current, (value) => formatAuto(value, unit)),
              {
                text: formatSignedPercent(deltaSafe),
                className: deltaClass(deltaSafe),
              },
              { text: signal.threshold ? `-${signal.threshold}%` : "" },
              {
                text: signal.status === "alert" ? "ALERT" : "OK",
                className: signal.status === "alert" ? "delta-negative" : "delta-positive",
              },
            ];
          });
          const header = ["Сигнал", "Текущее", "Δ%", "Порог", "Статус"];
          signalsTable.innerHTML = "";
          signalsTable.appendChild(buildMiniTable(header, rows));
        }
      }

      async function loadOverview() {
        if (!state.branchCode || !state.month) {
          renderEmpty(overviewKpis, "Нет данных");
          return;
        }
        renderEmpty(overviewKpis, "Загрузка данных...");
        try {
          const data = await fetchJSON(
            `/api/cuteam/overview?branch_code=${encodeURIComponent(state.branchCode)}&month=${encodeURIComponent(
              state.month
            )}`
          );
          state.overviewData = data;
          renderOverview(data);
        } catch (err) {
          console.error(err);
          renderEmpty(overviewKpis, "Не удалось загрузить обзор");
        }
      }

      async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Ошибка запроса: ${res.status}`);
        return res.json();
      }

      async function loadBranches() {
        const data = await fetchJSON("/api/cuteam/branches");
        const branches = data.branches || [];
        branchSelect.innerHTML = "";
        branches.forEach((branch) => {
          const opt = document.createElement("option");
          opt.value = branch.code;
          opt.textContent = branch.name || branch.code;
          branchSelect.appendChild(opt);
        });
        if (branches.length === 1) {
          branchField.style.display = "none";
          state.branchCode = branches[0].code;
        } else if (branches.length > 0) {
          state.branchCode = branches[0].code;
        }
      }

      async function loadMonths() {
        if (!state.branchCode) return;
        const data = await fetchJSON(`/api/cuteam/months?branch_code=${encodeURIComponent(state.branchCode)}`);
        const months = data.months || [];
        monthSelect.innerHTML = "";
        compareMonthSelect.innerHTML = "";
        if (months.length === 0) {
          state.month = null;
          state.compareMonth = null;
          monthSelect.disabled = true;
          compareMonthSelect.disabled = true;
          return;
        }
        monthSelect.disabled = false;
        compareMonthSelect.disabled = false;
        months.forEach((month) => {
          const opt = document.createElement("option");
          opt.value = month;
          opt.textContent = formatMonthLabel(month);
          monthSelect.appendChild(opt);
        });
        months.forEach((month) => {
          const opt = document.createElement("option");
          opt.value = month;
          opt.textContent = formatMonthLabel(month);
          compareMonthSelect.appendChild(opt);
        });
        if (months.length > 0) {
          state.month = months[0];
        }
        if (months.length > 1) {
          state.compareMonth = months[1];
        } else {
          state.compareMonth = months[0];
        }
      }

      function setPlanStatus(message, isError = false) {
        planStatus.textContent = message || "";
        if (!message) return;
        planStatus.style.color = isError ? "#b2412e" : "#2f7d55";
        setTimeout(() => {
          if (planStatus.textContent === message) planStatus.textContent = "";
        }, 2400);
      }

      function buildRawTable(data) {
        if (!data || !data.metrics || data.metrics.length === 0) {
          rawTableContainer.innerHTML = '<div class="empty-state">Нет данных за выбранный период.</div>';
          return;
        }

        const days = data.days || [];
        const weeks = data.weeks || [];
        const metrics = data.metrics || [];

        const table = document.createElement("table");
        table.className = "d1-table raw-table";

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");

        const thMetric = document.createElement("th");
        thMetric.textContent = "Показатель";
        thMetric.className = "metric-col sticky-col";
        headRow.appendChild(thMetric);

        let weekIndex = 0;
        days.forEach((day, idx) => {
          const th = document.createElement("th");
          th.textContent = String(day.day).padStart(2, "0");
          if (day.dow === 5 || day.dow === 6) {
            th.classList.add("day-weekend");
          }
          headRow.appendChild(th);

          if (weekIndex < weeks.length && idx === weeks[weekIndex].end_idx) {
            const thWeek = document.createElement("th");
            thWeek.textContent = "Итог нед.";
            thWeek.className = "week-total";
            headRow.appendChild(thWeek);
            weekIndex += 1;
          }
        });

        const thMonth = document.createElement("th");
        thMonth.textContent = "Итого месяц";
        thMonth.className = "month-total";
        headRow.appendChild(thMonth);

        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        metrics.forEach((metric) => {
          const row = document.createElement("tr");
          const nameCell = document.createElement("th");
          nameCell.textContent = metric.label;
          nameCell.className = "metric-col sticky-col";
          if (metric.is_header) {
            nameCell.classList.add("raw-header");
          }
          row.appendChild(nameCell);

          let idx = 0;
          weekIndex = 0;
          metric.values.forEach((value) => {
            const td = document.createElement("td");
            setCellValue(td, value, formatRawValue);
            row.appendChild(td);

            if (weekIndex < weeks.length && idx === weeks[weekIndex].end_idx) {
              const weekTd = document.createElement("td");
              weekTd.className = "week-total";
              const weekValue = metric.week_totals[weekIndex];
              setCellValue(weekTd, weekValue, formatRawValue);
              row.appendChild(weekTd);
              weekIndex += 1;
            }
            idx += 1;
          });

          const monthTd = document.createElement("td");
          monthTd.className = "month-total";
          setCellValue(monthTd, metric.month_total, formatRawValue);
          row.appendChild(monthTd);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        rawTableContainer.innerHTML = "";
        rawTableContainer.appendChild(table);
      }

      function buildComparisonTable(base, compare) {
        if (!base || !compare || !base.metrics) {
          compareTableContainer.innerHTML = '<div class="empty-state">Нет данных для сравнения.</div>';
          return;
        }

        const metrics = base.metrics || [];
        const compareMap = new Map((compare.metrics || []).map((m) => [m.code, m]));

        const table = document.createElement("table");
        table.className = "d1-table compare-table";

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");

        const thMetric = document.createElement("th");
        thMetric.textContent = "Показатель";
        thMetric.className = "metric-col sticky-col";
        headRow.appendChild(thMetric);

        const thA = document.createElement("th");
        thA.textContent = formatMonthLabel(base.month);
        headRow.appendChild(thA);

        const thB = document.createElement("th");
        thB.textContent = formatMonthLabel(compare.month);
        headRow.appendChild(thB);

        const thDelta = document.createElement("th");
        thDelta.textContent = "Δ";
        headRow.appendChild(thDelta);

        const thDeltaPct = document.createElement("th");
        thDeltaPct.textContent = "Δ%";
        headRow.appendChild(thDeltaPct);

        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        metrics.forEach((metric) => {
          const row = document.createElement("tr");
          const nameCell = document.createElement("th");
          nameCell.textContent = metric.label;
          nameCell.className = "metric-col sticky-col";
          if (metric.is_header) {
            nameCell.classList.add("raw-header");
          }
          row.appendChild(nameCell);

          const compareMetric = compareMap.get(metric.code);
          const valueA = metric.month_total;
          const valueB = compareMetric ? compareMetric.month_total : null;
          const delta = valueA !== null && valueB !== null ? valueA - valueB : null;
          const deltaPct =
            valueB !== null && valueB !== 0 && delta !== null ? (delta / valueB) * 100 : null;

          const tdA = document.createElement("td");
          setCellValue(tdA, valueA, formatRawValue);
          row.appendChild(tdA);

          const tdB = document.createElement("td");
          setCellValue(tdB, valueB, formatRawValue);
          row.appendChild(tdB);

          const tdDelta = document.createElement("td");
          const deltaSafe = valueOrZero(delta);
          tdDelta.textContent = formatSigned(deltaSafe);
          if (deltaSafe > 0) tdDelta.classList.add("delta-positive");
          if (deltaSafe < 0) tdDelta.classList.add("delta-negative");
          row.appendChild(tdDelta);

          const tdDeltaPct = document.createElement("td");
          const deltaPctSafe = valueOrZero(deltaPct);
          tdDeltaPct.textContent = formatSignedPercent(deltaPctSafe);
          if (deltaPctSafe > 0) tdDeltaPct.classList.add("delta-positive");
          if (deltaPctSafe < 0) tdDeltaPct.classList.add("delta-negative");
          row.appendChild(tdDeltaPct);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        compareTableContainer.innerHTML = "";
        compareTableContainer.appendChild(table);
      }

      function buildComparisonTSV(base, compare) {
        if (!base || !compare || !base.metrics) return "";
        const metrics = base.metrics || [];
        const compareMap = new Map((compare.metrics || []).map((m) => [m.code, m]));
        const header = [
          "Показатель",
          formatMonthLabel(base.month),
          formatMonthLabel(compare.month),
          "Δ",
          "Δ%",
        ];
        const lines = [header.join("	")];
        metrics.forEach((metric) => {
          const compareMetric = compareMap.get(metric.code);
          const valueA = metric.month_total;
          const valueB = compareMetric ? compareMetric.month_total : null;
          const delta = valueA !== null && valueB !== null ? valueA - valueB : null;
          const deltaPct =
            valueB !== null && valueB !== 0 && delta !== null ? (delta / valueB) * 100 : null;
          const deltaSafe = valueOrZero(delta);
          const deltaValue =
            deltaSafe === 0 ? "0" : deltaSafe > 0 ? `+${deltaSafe}` : String(deltaSafe);
          const deltaPctSafe = valueOrZero(deltaPct);
          const deltaPctValue =
            deltaPctSafe === 0
              ? "0"
              : `${deltaPctSafe > 0 ? "+" : ""}${deltaPctSafe.toFixed(2)}`;
          lines.push(
            [
              metric.label,
              tsvValue(valueA),
              tsvValue(valueB),
              deltaValue,
              deltaPctValue,
            ].join("	")
          );
        });
        return lines.join("\n");
      }

      async function copyCompareTSV() {
        if (!state.compareData) {
          compareCopyStatus.textContent = "Нет данных";
          return;
        }
        const tsv = buildComparisonTSV(state.compareData.base, state.compareData.compare);
        if (!tsv) {
          compareCopyStatus.textContent = "Нет данных";
          return;
        }
        try {
          await navigator.clipboard.writeText(tsv);
          compareCopyStatus.textContent = "Скопировано";
          setTimeout(() => (compareCopyStatus.textContent = ""), 2400);
        } catch (err) {
          compareCopyStatus.textContent = "Не удалось";
          setTimeout(() => (compareCopyStatus.textContent = ""), 2400);
        }
      }

      function buildYearTable(data) {
        if (!data || !data.metrics || data.metrics.length === 0) {
          yearTableContainer.innerHTML = '<div class="empty-state">Нет данных для годовой сводки.</div>';
          return;
        }

        const months = data.months || [];
        const groups = data.groups || [];
        const metrics = data.metrics || [];

        const monthLabels = {
          "01": "янв",
          "02": "фев",
          "03": "мар",
          "04": "апр",
          "05": "май",
          "06": "июн",
          "07": "июл",
          "08": "авг",
          "09": "сен",
          "10": "окт",
          "11": "ноя",
          "12": "дек",
        };

        const table = document.createElement("table");
        table.className = "d1-table year-table";

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");

        const thMetric = document.createElement("th");
        thMetric.textContent = "Показатель";
        thMetric.className = "metric-col sticky-col";
        headRow.appendChild(thMetric);

        months.forEach((month) => {
          const m = month.slice(5, 7);
          const y = month.slice(2, 4);
          const th = document.createElement("th");
          th.className = "month-head";
          th.textContent = `${monthLabels[m] || m} ${y}`;
          headRow.appendChild(th);
        });

        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        const metricMap = new Map(metrics.map((m) => [m.code, m]));

        groups.forEach((group) => {
          const groupRow = document.createElement("tr");
          groupRow.className = "group-row";
          const th = document.createElement("th");
          th.colSpan = months.length + 1;
          th.className = "group-label sticky-col";
          th.textContent = group.label;
          groupRow.appendChild(th);
          tbody.appendChild(groupRow);

          group.metrics.forEach((code) => {
            const metric = metricMap.get(code);
            if (!metric) return;

            const planRow = document.createElement("tr");
            const planLabel = document.createElement("th");
            planLabel.textContent = "План";
            planLabel.className = "metric-col sticky-col";
            planRow.appendChild(planLabel);
            months.forEach((month) => {
              const td = document.createElement("td");
              td.className = "plan-col";
              const input = document.createElement("input");
              input.type = "number";
              input.step = "0.01";
              input.value = metric.plan[month] ?? "";
              input.addEventListener("blur", async (event) => {
                const nextValue = Number(event.target.value || 0);
                try {
                  await savePlan(metric.code, nextValue, month);
                  updateYearPlanLocal(metric.code, month, nextValue);
                  if (state.summaryMonth === month) {
                    updatePlanLocal(metric.code, nextValue);
                    buildTable(state.data);
                  }
                } catch (err) {
                  console.error(err);
                }
              });
              input.addEventListener("keydown", (event) => {
                if (event.key === "Enter") event.target.blur();
              });
              td.appendChild(input);
              planRow.appendChild(td);
            });
            tbody.appendChild(planRow);

            const factRow = document.createElement("tr");
            const factLabel = document.createElement("th");
            factLabel.textContent = metric.label;
            factLabel.className = "metric-col sticky-col";
            factRow.appendChild(factLabel);
            months.forEach((month) => {
              const td = document.createElement("td");
              const factValue = metric.fact[month];
              const planValue = metric.plan[month];
              setCellValue(td, factValue, formatRawValue);
              if (
                planValue !== null &&
                planValue !== undefined &&
                factValue !== null &&
                factValue !== undefined
              ) {
                td.classList.add(factValue >= planValue ? "fact-above" : "fact-below");
              }
              factRow.appendChild(td);
            });
            tbody.appendChild(factRow);
          });
        });

        table.appendChild(tbody);
        yearTableContainer.innerHTML = "";
        yearTableContainer.appendChild(table);
      }

      function buildYearTSV(data) {
        if (!data || !data.metrics) return "";
        const months = data.months || [];
        const groups = data.groups || [];
        const metrics = data.metrics || [];
        const metricMap = new Map(metrics.map((m) => [m.code, m]));

        const monthLabels = {
          "01": "янв",
          "02": "фев",
          "03": "мар",
          "04": "апр",
          "05": "май",
          "06": "июн",
          "07": "июл",
          "08": "авг",
          "09": "сен",
          "10": "окт",
          "11": "ноя",
          "12": "дек",
        };
        const header = [
          "Показатель",
          ...months.map((month) => {
            const m = month.slice(5, 7);
            const y = month.slice(2, 4);
            return `${monthLabels[m] || m} ${y}`;
          }),
        ];
        const lines = [header.join("	")];
        groups.forEach((group) => {
          lines.push([group.label].join("	"));
          group.metrics.forEach((code) => {
            const metric = metricMap.get(code);
            if (!metric) return;
            const planRow = ["План", ...months.map((m) => tsvValue(metric.plan[m]))];
            lines.push(planRow.join("	"));
            const factRow = [metric.label, ...months.map((m) => tsvValue(metric.fact[m]))];
            lines.push(factRow.join("	"));
          });
        });
        return lines.join("\n");
      }

      async function copyYearTSV() {
        if (!state.yearData) {
          yearCopyStatus.textContent = "Нет данных";
          return;
        }
        const tsv = buildYearTSV(state.yearData);
        if (!tsv) {
          yearCopyStatus.textContent = "Нет данных";
          return;
        }
        try {
          await navigator.clipboard.writeText(tsv);
          yearCopyStatus.textContent = "Скопировано";
          setTimeout(() => (yearCopyStatus.textContent = ""), 2400);
        } catch (err) {
          yearCopyStatus.textContent = "Не удалось";
          setTimeout(() => (yearCopyStatus.textContent = ""), 2400);
        }
      }

      async function savePlan(metricCode, value, monthValue) {
        const payload = {
          branch_code: state.branchCode,
          month: monthValue || state.month,
          metric_code: metricCode,
          value: value,
        };
        const res = await fetch("/api/cuteam/plans", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          throw new Error("Не удалось сохранить план");
        }
      }

      function updatePlanLocal(metricCode, value) {
        if (!state.data || !state.data.metrics) return;
        state.data.metrics.forEach((metric) => {
          if (metric.code === metricCode) {
            metric.plan = value;
            if (metric.month_total !== null && metric.month_total !== undefined) {
              if (value !== 0) {
                metric.plan_pct = (metric.month_total / value) * 100;
              } else {
                metric.plan_pct = null;
              }
              metric.plan_delta = metric.month_total - value;
            } else {
              metric.plan_pct = null;
              metric.plan_delta = null;
            }
          }
        });
      }

      function updateYearPlanLocal(metricCode, month, value) {
        if (!state.yearData || !state.yearData.metrics) return;
        state.yearData.metrics.forEach((metric) => {
          if (metric.code === metricCode) {
            metric.plan[month] = value;
          }
        });
      }

      function buildTable(data) {
        if (!data || !data.metrics || data.metrics.length === 0) {
          tableContainer.innerHTML = '<div class="empty-state">Нет данных за выбранный период.</div>';
          return;
        }

        const weeks = data.weeks || [];
        const weekLabels = data.week_labels || [];
        const metrics = data.metrics || [];
        const groups = data.groups || {};

        const weekCount = weekLabels.length || weeks.length;
        const totalCols = 2 + weekCount + 4;

        const table = document.createElement("table");
        table.className = "d1-table";

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");

        const thMetric = document.createElement("th");
        thMetric.textContent = "Показатель";
        thMetric.className = "metric-col sticky-col";
        headRow.appendChild(thMetric);

        const thUnit = document.createElement("th");
        thUnit.textContent = "Ед.";
        thUnit.className = "unit-col sticky-col";
        headRow.appendChild(thUnit);

        if (weekLabels.length) {
          weekLabels.forEach((label) => {
            const th = document.createElement("th");
            th.textContent = label;
            th.className = "week-total";
            headRow.appendChild(th);
          });
        } else {
          weeks.forEach((week, idx) => {
            const th = document.createElement("th");
            const start = week.start.slice(8, 10);
            const end = week.end.slice(8, 10);
            th.textContent = `Нед ${idx + 1} (${start}–${end})`;
            th.className = "week-total";
            headRow.appendChild(th);
          });
        }

        const thMonth = document.createElement("th");
        thMonth.textContent = "Итого месяц";
        thMonth.className = "month-total";
        headRow.appendChild(thMonth);

        const thPlan = document.createElement("th");
        thPlan.textContent = "План";
        thPlan.className = "plan-col";
        headRow.appendChild(thPlan);

        const thForecast = document.createElement("th");
        thForecast.textContent = "Прогноз";
        thForecast.className = "plan-col";
        headRow.appendChild(thForecast);

        const thPct = document.createElement("th");
        thPct.textContent = "%";
        thPct.className = "plan-col";
        headRow.appendChild(thPct);

        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        let currentGroup = null;

        metrics.forEach((metric) => {
          if (metric.group !== currentGroup) {
            const groupRow = document.createElement("tr");
            groupRow.className = "group-row";
            const th = document.createElement("th");
            th.colSpan = 2;
            th.className = "group-label sticky-col";
            th.textContent = groups[metric.group] || metric.group;
            groupRow.appendChild(th);
            const fill = document.createElement("td");
            fill.colSpan = totalCols - 2;
            fill.className = "group-fill";
            groupRow.appendChild(fill);
            tbody.appendChild(groupRow);
            currentGroup = metric.group;
          }

          const row = document.createElement("tr");
          const nameCell = document.createElement("th");
          nameCell.textContent = metric.label;
          nameCell.className = "metric-col sticky-col";
          row.appendChild(nameCell);

          const unitCell = document.createElement("td");
          unitCell.textContent =
            metric.unit === "rub"
              ? "руб"
              : metric.unit === "qty"
              ? "шт"
              : metric.unit === "pct"
              ? "%"
              : metric.unit;
          unitCell.className = "unit-col sticky-col";
          row.appendChild(unitCell);

          metric.week_totals.forEach((value) => {
            const td = document.createElement("td");
            td.className = "week-total";
            setCellValue(td, value, (v) => formatValue(v, metric.unit));
            row.appendChild(td);
          });

          const monthTd = document.createElement("td");
          monthTd.className = "month-total";
          setCellValue(monthTd, metric.month_total, (v) => formatValue(v, metric.unit));
          row.appendChild(monthTd);

          const planTd = document.createElement("td");
          planTd.className = "plan-col";
          setCellValue(planTd, metric.plan, formatRawValue);
          row.appendChild(planTd);

          const forecastTd = document.createElement("td");
          forecastTd.className = "plan-col";
          setCellValue(forecastTd, metric.forecast, formatRawValue);
          row.appendChild(forecastTd);

          const pctTd = document.createElement("td");
          pctTd.className = "plan-col";
          setCellValue(pctTd, metric.forecast_pct, (v) => formatValue(v, "pct"));
          row.appendChild(pctTd);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        tableContainer.innerHTML = "";
        tableContainer.appendChild(table);
      }

      async function loadSummary() {
        if (!state.branchCode) return;
        if (!state.month) {
          tableContainer.innerHTML =
            '<div class="empty-state">Нет данных для выбранного филиала. Проверьте синхронизацию в админке.</div>';
          return;
        }
        tableContainer.innerHTML = '<div class="empty-state">Загрузка данных…</div>';
        try {
          const data = await fetchJSON(
            `/api/cuteam/d1?branch_code=${encodeURIComponent(state.branchCode)}&month=${encodeURIComponent(state.month)}`
          );
          state.data = data;
          state.summaryMonth = data.month;
          buildTable(data);
        } catch (err) {
          console.error(err);
          tableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить данные.</div>';
        }
      }

      async function loadRaw() {
        if (!state.branchCode) return;
        if (!state.month) {
          rawTableContainer.innerHTML = '<div class="empty-state">Нет данных за выбранный период.</div>';
          return;
        }
        rawTableContainer.innerHTML = '<div class="empty-state">Загрузка данных…</div>';
        try {
          const data = await fetchJSON(
            `/api/cuteam/raw?branch_code=${encodeURIComponent(state.branchCode)}&month=${encodeURIComponent(state.month)}`
          );
          state.rawData = data;
          buildRawTable(data);
        } catch (err) {
          console.error(err);
          rawTableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить данные.</div>';
        }
      }

      async function loadComparison() {
        if (!state.branchCode || !state.month || !state.compareMonth) {
          compareTableContainer.innerHTML = '<div class="empty-state">Нет данных для сравнения.</div>';
          return;
        }
        compareTableContainer.innerHTML = '<div class="empty-state">Загрузка данных…</div>';
        try {
          const base =
            state.rawData && state.rawData.month === state.month
              ? state.rawData
              : await fetchJSON(
                  `/api/cuteam/raw?branch_code=${encodeURIComponent(state.branchCode)}&month=${encodeURIComponent(
                    state.month
                  )}`
                );
          const compare = await fetchJSON(
            `/api/cuteam/raw?branch_code=${encodeURIComponent(state.branchCode)}&month=${encodeURIComponent(
              state.compareMonth
            )}`
          );
          state.compareData = { base, compare };
          buildComparisonTable(base, compare);
        } catch (err) {
          console.error(err);
          compareTableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить данные.</div>';
        }
      }

      async function loadYearSummary() {
        if (!state.branchCode) return;
        yearTableContainer.innerHTML = '<div class="empty-state">Загрузка данных…</div>';
        try {
          const data = await fetchJSON(
            `/api/cuteam/year-summary?branch_code=${encodeURIComponent(state.branchCode)}`
          );
          state.yearData = data;
          buildYearTable(data);
        } catch (err) {
          console.error(err);
          yearTableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить данные.</div>';
        }
      }

      async function loadData() {
        await Promise.all([loadSummary(), loadRaw(), loadComparison(), loadYearSummary(), loadOverview()]);
      }


      rawCopyBtn.addEventListener("click", () => {
        copyRawTSV();
      });
      summaryCopyBtn.addEventListener("click", () => {
        copySummaryTSV();
      });
      compareCopyBtn.addEventListener("click", () => {
        copyCompareTSV();
      });
      yearCopyBtn.addEventListener("click", () => {
        copyYearTSV();
      });

      branchSelect.addEventListener("change", async (event) => {
        state.branchCode = event.target.value;
        await loadMonths();
        monthSelect.value = state.month;
        compareMonthSelect.value = state.compareMonth;
        loadData();
      });

      monthSelect.addEventListener("change", (event) => {
        state.month = event.target.value;
        loadData();
      });

      compareMonthSelect.addEventListener("change", (event) => {
        state.compareMonth = event.target.value;
        loadComparison();
      });

      document.querySelectorAll('input[name="scale"]').forEach((radio) => {
        radio.addEventListener("change", (event) => {
          state.scale = event.target.value;
        });
      });

      (async function init() {
        try {
          await loadBranches();
          if (!state.branchCode) {
            tableContainer.innerHTML = '<div class="empty-state">Нет филиалов для отображения.</div>';
            rawTableContainer.innerHTML = '<div class="empty-state">Нет филиалов для отображения.</div>';
            compareTableContainer.innerHTML = '<div class="empty-state">Нет филиалов для отображения.</div>';
            yearTableContainer.innerHTML = '<div class="empty-state">Нет филиалов для отображения.</div>';
            return;
          }
          await loadMonths();
          monthSelect.value = state.month;
          compareMonthSelect.value = state.compareMonth;
          await loadData();
        } catch (err) {
          console.error(err);
          tableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить настройки.</div>';
          rawTableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить настройки.</div>';
          compareTableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить настройки.</div>';
          yearTableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить настройки.</div>';
        }
      })();
    </script>
  </body>
</html>
