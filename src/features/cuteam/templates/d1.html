<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cuteam · Коворкинг + Кофейня</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <style>
      .cuteam-card {
        background: var(--shell);
        border-radius: var(--radius-lg);
        padding: 18px;
        box-shadow: var(--shadow);
        margin-top: 20px;
      }

      .card-head {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .card-title {
        margin: 6px 0 0;
        font-size: 18px;
      }

      .card-subtitle {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
      }

      .card-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .copy-status {
        font-size: 12px;
        color: var(--muted);
      }

      .legend-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 16px;
        color: var(--muted);
        font-size: 12px;
        align-items: center;
      }

      .legend-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--card);
        border-radius: 999px;
        padding: 6px 12px;
        border: 1px solid var(--border-soft);
      }

      .pill-dot {
        width: 10px;
        height: 10px;
        border-radius: 3px;
        display: inline-block;
      }

      .pill-week {
        background: rgba(217, 154, 131, 0.35);
      }

      .pill-month {
        background: rgba(247, 201, 118, 0.4);
      }

      .pill-plan {
        background: rgba(233, 189, 166, 0.35);
      }

      .d1-scroll {
        overflow: auto;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-soft);
        background: var(--card);
        max-height: 70vh;
      }

      .d1-table {
        border-collapse: separate;
        border-spacing: 0;
        min-width: 980px;
        width: 100%;
      }

      .d1-table th,
      .d1-table td {
        padding: 6px 8px;
        border-bottom: 1px solid var(--border-soft);
        border-right: 1px solid var(--border-soft);
        font-size: 12px;
        line-height: 1.2;
        text-align: right;
        white-space: nowrap;
      }

      .d1-table thead th {
        position: sticky;
        top: 0;
        background: var(--card);
        z-index: 5;
        font-weight: 600;
      }

      .d1-table th.metric-col {
        text-align: left;
        min-width: 230px;
        max-width: 260px;
      }

      .d1-table th.unit-col {
        min-width: 70px;
        text-align: center;
      }

      .sticky-col {
        position: sticky;
        left: 0;
        background: var(--card);
        z-index: 4;
        box-shadow: 2px 0 0 var(--border-soft);
      }

      .sticky-col.unit-col {
        left: 230px;
        z-index: 4;
      }

      .d1-table thead th.sticky-col {
        z-index: 7;
      }

      .raw-table th,
      .raw-table td {
        font-size: 11px;
        padding: 5px 6px;
      }

      .day-weekend {
        color: var(--accent);
        font-weight: 600;
      }

      .compare-table th.metric-col {
        min-width: 240px;
      }

      .year-table th.metric-col {
        min-width: 220px;
      }

      .year-table th.year-head {
        text-align: center;
      }

      .year-table th.month-head {
        font-size: 11px;
        text-align: center;
      }

      .year-table td.plan-col input {
        width: 100%;
        min-width: 70px;
      }

      .raw-table th.metric-col {
        min-width: 280px;
        max-width: 320px;
      }

      .group-row th {
        background: rgba(233, 189, 166, 0.3);
        font-weight: 600;
        text-align: left;
        color: var(--ink);
      }

      .group-label {
        min-width: 300px;
        text-align: left;
      }

      .group-fill {
        background: rgba(233, 189, 166, 0.3);
        border-bottom: 1px solid var(--border-soft);
      }

      .week-total {
        background: rgba(233, 189, 166, 0.2);
        font-weight: 600;
      }

      .month-total {
        background: rgba(247, 201, 118, 0.35);
        font-weight: 600;
      }

      .plan-col {
        background: rgba(217, 154, 131, 0.2);
      }

      .d1-table td.plan-col input {
        width: 100%;
        border: 1px solid var(--border);
        background: var(--card);
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 12px;
        text-align: right;
      }

      .plan-status {
        margin-left: auto;
        font-size: 12px;
        color: var(--muted);
      }

      .day-head {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      }

      .day-head strong {
        font-size: 12px;
      }

      .day-head span {
        font-size: 10px;
        color: var(--muted);
      }

      .toggle-group {
        display: flex;
        gap: 8px;
      }

      .toggle-group label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--muted);
      }

      .empty-state {
        padding: 24px;
        text-align: center;
        color: var(--muted);
      }

      .delta-positive {
        color: #1f5e46;
        font-weight: 600;
      }

      .delta-negative {
        color: #8b1e1e;
        font-weight: 600;
      }

      .raw-header {
        font-weight: 700;
      }

      .fact-above {
        color: #1f5e46;
        font-weight: 600;
      }

      .fact-below {
        color: #8b1e1e;
        font-weight: 600;
      }

      .section-divider {
        height: 3px;
        border-radius: 999px;
        background: var(--ink);
        opacity: 0.2;
        margin: 28px 0 18px;
      }

      .overview-grid {
        display: grid;
        gap: 12px;
      }

      .overview-item {
        background: var(--card);
        border: 1px solid var(--border-soft);
        border-radius: var(--radius-md);
        padding: 14px;
      }

      .overview-item h3 {
        margin: 0 0 6px;
        font-size: 15px;
      }

      .overview-item p {
        margin: 0;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.4;
      }

      @media (min-width: 960px) {
        .overview-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="topbar">
        <div>
          <div class="eyebrow">Cuteam</div>
          <h1>Дашборд / Коворкинг + Кофейня</h1>
          <p class="subtitle">Данные из Google Sheet · дни/недели</p>
        </div>
        <div class="actions">
          <a class="ghost" href="/cuteam">Показатели</a>
          <a class="ghost" href="/">Теплокарта</a>
          <a class="ghost" href="/historical">Исторические</a>
          <a class="ghost" href="/summary">Свод</a>
          <a class="ghost" href="/admin">Админка</a>
        </div>
      </header>

      <section class="filters">
        <div class="field" id="branchField">
          <label>Филиал</label>
          <select id="branchSelect"></select>
        </div>
        <div class="field">
          <label>Месяц</label>
          <select id="monthSelect"></select>
        </div>
        <div class="field">
          <label>Месяц сравнения</label>
          <select id="compareMonthSelect"></select>
        </div>
        <div class="field">
          <label>Сравнение</label>
          <div class="toggle-group">
            <label><input type="radio" name="scale" value="weeks" checked /> Недели</label>
            <label><input type="radio" name="scale" value="months" /> Месяц</label>
          </div>
        </div>
        <div class="field">
          <label>Пересчитать</label>
          <button class="ghost" id="recalcBtn" type="button">Пересчитать</button>
          <div class="copy-status" id="recalcStatus"></div>
        </div>
      </section>

      <section class="cuteam-card">
        <div class="card-head">
          <div>
            <div class="eyebrow">Сырой месяц</div>
            <h2 class="card-title">Исходные данные по дням</h2>
            <div class="card-subtitle">Полная таблица из Google Sheet (без сравнений)</div>
          </div>
          <div class="card-actions">
            <button class="ghost" id="rawCopyBtn" type="button">Скопировать TSV</button>
            <div class="plan-status" id="rawCopyStatus"></div>
          </div>
        </div>
        <div id="rawTableContainer" class="d1-scroll">
          <div class="empty-state">Загрузка данных…</div>
        </div>
      </section>

      <section class="cuteam-card">
        <div class="card-head">
          <div>
            <div class="eyebrow">Свод</div>
            <h2 class="card-title">Агрегированные показатели в динамике</h2>
            <div class="card-subtitle">Недели предыдущего месяца (5 недель)</div>
          </div>
          <div class="card-actions">
            <button class="ghost" id="summaryCopyBtn" type="button">Скопировать TSV</button>
            <div class="copy-status" id="summaryCopyStatus"></div>
            <div class="plan-status" id="planStatus"></div>
          </div>
        </div>
        <div id="tableContainer" class="d1-scroll">
          <div class="empty-state">Загрузка данных…</div>
        </div>
      </section>

      <section class="cuteam-card">
        <div class="card-head">
          <div>
            <div class="eyebrow">Сравнение</div>
            <h2 class="card-title">Сравнение месяцев</h2>
            <div class="card-subtitle">Основной месяц vs месяц сравнения</div>
          </div>
          <div class="card-actions">
            <button class="ghost" id="compareCopyBtn" type="button">Скопировать TSV</button>
            <div class="copy-status" id="compareCopyStatus"></div>
          </div>
        </div>
        <div id="compareTableContainer" class="d1-scroll">
          <div class="empty-state">Загрузка данных…</div>
        </div>
      </section>

      <section class="cuteam-card">
        <div class="card-head">
          <div>
            <div class="eyebrow">Годовая сводка</div>
            <h2 class="card-title">План / факт по месяцам</h2>
            <div class="card-subtitle">Ключевые направления по годам и месяцам</div>
          </div>
          <div class="card-actions">
            <button class="ghost" id="yearCopyBtn" type="button">Скопировать TSV</button>
            <div class="copy-status" id="yearCopyStatus"></div>
          </div>
        </div>
        <div id="yearTableContainer" class="d1-scroll">
          <div class="empty-state">Загрузка данных…</div>
        </div>
      </section>

      <div class="section-divider"></div>

      <section class="cuteam-card">
        <div class="card-head">
          <div>
            <div class="eyebrow">NEW Overview</div>
            <h2 class="card-title">NEW Overview</h2>
            <div class="card-subtitle">Структура будущих дашбордов и KPI</div>
          </div>
        </div>
        <div class="overview-grid">
          <div class="overview-item">
            <h3>1. Главный управленческий дашборд</h3>
            <p>KPI: выручка всего, коворкинг всего, кофейня всего (checks + avg check), загрузка, порча (writeoff rate).</p>
          </div>
          <div class="overview-item">
            <h3>2. Доходы в целом</h3>
            <p>Динамика выручки + сравнение периодов (WoW, YoY, лучший период), структура наличные/безнал.</p>
          </div>
          <div class="overview-item">
            <h3>3. Коворкинг: доходы по направлениям</h3>
            <p>Направления аренда/кабинеты/лекторий/лаборатория/ритейл/салон + ratio лаборатория/аренда.</p>
          </div>
          <div class="overview-item">
            <h3>4. Кофейня: основные показатели</h3>
            <p>Выручка, чеки, средний чек + сравнение WoW/YoY и среднее за 8 недель.</p>
          </div>
          <div class="overview-item">
            <h3>5. Кофейня: структура продаж</h3>
            <p>Еда и напитки по категориям, структура недели, сезонность.</p>
          </div>
          <div class="overview-item">
            <h3>6. Загрузка и эффективность</h3>
            <p>Связь загрузки с выручкой (open space, лаборатория, кофейня) + revenue per load.</p>
          </div>
          <div class="overview-item">
            <h3>7. Списания и порча</h3>
            <p>sold_food_total vs written_off_food_total и writeoff_rate относительно нормы.</p>
          </div>
          <div class="overview-item">
            <h3>8. Деньги и касса</h3>
            <p>Наличные/безнал, остаток кассы, изъятия, внесения + контроль движения.</p>
          </div>
          <div class="overview-item">
            <h3>9. Расходы</h3>
            <p>Все основные расходы, структура по категориям, доля от выручки.</p>
          </div>
          <div class="overview-item">
            <h3>10. Прибыль и рентабельность</h3>
            <p>Gross/operating profit и маржинальность по неделям.</p>
          </div>
          <div class="overview-item">
            <h3>11. Сигналы и контроль</h3>
            <p>Автоматические алерты по доходам, кофейне, загрузке, кассе и расходам.</p>
          </div>
        </div>
      </section>
    </div>

    <script>
      const state = {
        branchCode: null,
        month: null,
        summaryMonth: null,
        compareMonth: null,
        scale: "weeks",
        data: null,
        rawData: null,
        compareData: null,
        yearData: null,
      };

      const branchSelect = document.getElementById("branchSelect");
      const monthSelect = document.getElementById("monthSelect");
      const compareMonthSelect = document.getElementById("compareMonthSelect");
      const tableContainer = document.getElementById("tableContainer");
      const rawTableContainer = document.getElementById("rawTableContainer");
      const rawCopyBtn = document.getElementById("rawCopyBtn");
      const rawCopyStatus = document.getElementById("rawCopyStatus");
      const summaryCopyBtn = document.getElementById("summaryCopyBtn");
      const summaryCopyStatus = document.getElementById("summaryCopyStatus");
      const compareTableContainer = document.getElementById("compareTableContainer");
      const compareCopyBtn = document.getElementById("compareCopyBtn");
      const compareCopyStatus = document.getElementById("compareCopyStatus");
      const yearTableContainer = document.getElementById("yearTableContainer");
      const yearCopyBtn = document.getElementById("yearCopyBtn");
      const yearCopyStatus = document.getElementById("yearCopyStatus");
      const planStatus = document.getElementById("planStatus");
      const branchField = document.getElementById("branchField");
      const recalcBtn = document.getElementById("recalcBtn");
      const recalcStatus = document.getElementById("recalcStatus");


      function formatNumber(value, decimals = 0) {
        return new Intl.NumberFormat("ru-RU", {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals,
        }).format(value);
      }

      function formatValue(value, unit) {
        if (value === null || value === undefined) return "";
        if (unit === "pct") {
          return `${formatNumber(value, 1)}%`;
        }
        if (unit === "ratio") {
          return formatNumber(value, 2);
        }
        if (unit === "rub") {
          return formatNumber(value, Math.abs(value % 1) > 0.01 ? 2 : 0);
        }
        if (unit === "qty") {
          return formatNumber(value, 0);
        }
        return formatNumber(value, 0);
      }

      function formatRawValue(value) {
        if (value === null || value === undefined) return "";
        const decimals = Math.abs(value % 1) > 0.01 ? 2 : 0;
        return formatNumber(value, decimals);
      }

      function formatSigned(value) {
        if (value === null || value === undefined) return "";
        if (value === 0) return "0";
        const sign = value > 0 ? "+" : "-";
        return `${sign}${formatRawValue(Math.abs(value))}`;
      }

      function formatSignedPercent(value) {
        if (value === null || value === undefined) return "";
        if (value === 0) return "0%";
        const sign = value > 0 ? "+" : "-";
        return `${sign}${formatNumber(Math.abs(value), 1)}%`;
      }

      function formatPlanSummary(planPct, planDelta) {
        if (planPct === null || planPct === undefined) return "";
        const pct = `${formatNumber(planPct, 0)}%`;
        if (planDelta === null || planDelta === undefined) return pct;
        const delta = formatNumber(planDelta, Math.abs(planDelta % 1) > 0.01 ? 2 : 0);
        return `${pct} · ${delta}`;
      }

      function formatMonthLabel(isoMonth) {
        const [year, month] = isoMonth.split("-");
        const date = new Date(Number(year), Number(month) - 1, 1);
        return new Intl.DateTimeFormat("ru-RU", { month: "long", year: "numeric" }).format(date);
      }

      function setCopyStatus(message, isError = false) {
        rawCopyStatus.textContent = message || "";
        if (!message) return;
        rawCopyStatus.style.color = isError ? "#b2412e" : "#2f7d55";
        setTimeout(() => {
          if (rawCopyStatus.textContent === message) rawCopyStatus.textContent = "";
        }, 2400);
      }

      function tsvValue(value) {
        if (value === null || value === undefined) return "";
        if (Number.isNaN(value)) return "";
        return String(value);
      }

      function buildRawTSV(data) {
        const days = data.days || [];
        const weeks = data.weeks || [];
        const metrics = data.metrics || [];

        const header = ["Показатель"];
        let weekIndex = 0;
        days.forEach((day, idx) => {
          header.push(String(day.day).padStart(2, "0"));
          if (weekIndex < weeks.length && idx === weeks[weekIndex].end_idx) {
            header.push("Итог нед.");
            weekIndex += 1;
          }
        });
        header.push("Итого месяц");

        const lines = [header.join("\t")];
        metrics.forEach((metric) => {
          const row = [metric.label];
          let idx = 0;
          weekIndex = 0;
          metric.values.forEach((value) => {
            row.push(tsvValue(value));
            if (weekIndex < weeks.length && idx === weeks[weekIndex].end_idx) {
              row.push(tsvValue(metric.week_totals[weekIndex]));
              weekIndex += 1;
            }
            idx += 1;
          });
          row.push(tsvValue(metric.month_total));
          lines.push(row.join("\t"));
        });
        return lines.join("\n");
      }

      async function copyRawTSV() {
        if (!state.rawData || !state.rawData.metrics || state.rawData.metrics.length === 0) {
          setCopyStatus("Нет данных для копирования", true);
          return;
        }
        const tsv = buildRawTSV(state.rawData);
        try {
          await navigator.clipboard.writeText(tsv);
          setCopyStatus("Скопировано");
        } catch (err) {
          try {
            const textarea = document.createElement("textarea");
            textarea.value = tsv;
            textarea.style.position = "fixed";
            textarea.style.opacity = "0";
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
            setCopyStatus("Скопировано");
          } catch (fallbackErr) {
            console.error(fallbackErr);
            setCopyStatus("Не удалось скопировать", true);
          }
        }
      }

      function buildSummaryTSV() {
        if (!state.data || !state.data.metrics) return "";
        const weeks = state.data.weeks || [];
        const weekLabels = state.data.week_labels || [];
        const metrics = state.data.metrics || [];

        const header = ["Показатель", "Ед."];
        if (weekLabels.length) {
          weekLabels.forEach((label) => {
            header.push(label);
          });
        } else {
          weeks.forEach((week, idx) => {
            const start = week.start.slice(8, 10);
            const end = week.end.slice(8, 10);
            header.push(`Нед ${idx + 1} (${start}-${end})`);
          });
        }
        header.push("Итого месяц", "План месяц", "Факт vs План");

        const lines = [header.join("\t")];
        metrics.forEach((metric) => {
          const row = [metric.label, metric.unit];
          metric.week_totals.forEach((value) => {
            row.push(tsvValue(value));
          });
          row.push(tsvValue(metric.month_total));
          row.push(metric.plan_enabled ? tsvValue(metric.plan ?? "") : "");
          row.push(formatPlanSummary(metric.plan_pct, metric.plan_delta));
          lines.push(row.join("\t"));
        });
        return lines.join("\n");
      }

      async function copySummaryTSV() {
        const tsv = buildSummaryTSV();
        if (!tsv) {
          summaryCopyStatus.textContent = "Нет данных";
          return;
        }
        try {
          await navigator.clipboard.writeText(tsv);
          summaryCopyStatus.textContent = "Скопировано";
          setTimeout(() => (summaryCopyStatus.textContent = ""), 2400);
        } catch (err) {
          summaryCopyStatus.textContent = "Не удалось";
          setTimeout(() => (summaryCopyStatus.textContent = ""), 2400);
        }
      }

      async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Ошибка запроса: ${res.status}`);
        return res.json();
      }

      async function loadBranches() {
        const data = await fetchJSON("/api/cuteam/branches");
        const branches = data.branches || [];
        branchSelect.innerHTML = "";
        branches.forEach((branch) => {
          const opt = document.createElement("option");
          opt.value = branch.code;
          opt.textContent = branch.name || branch.code;
          branchSelect.appendChild(opt);
        });
        if (branches.length === 1) {
          branchField.style.display = "none";
          state.branchCode = branches[0].code;
        } else if (branches.length > 0) {
          state.branchCode = branches[0].code;
        }
      }

      async function loadMonths() {
        if (!state.branchCode) return;
        const data = await fetchJSON(`/api/cuteam/months?branch_code=${encodeURIComponent(state.branchCode)}`);
        const months = data.months || [];
        monthSelect.innerHTML = "";
        compareMonthSelect.innerHTML = "";
        if (months.length === 0) {
          state.month = null;
          state.compareMonth = null;
          monthSelect.disabled = true;
          compareMonthSelect.disabled = true;
          return;
        }
        monthSelect.disabled = false;
        compareMonthSelect.disabled = false;
        months.forEach((month) => {
          const opt = document.createElement("option");
          opt.value = month;
          opt.textContent = formatMonthLabel(month);
          monthSelect.appendChild(opt);
        });
        months.forEach((month) => {
          const opt = document.createElement("option");
          opt.value = month;
          opt.textContent = formatMonthLabel(month);
          compareMonthSelect.appendChild(opt);
        });
        if (months.length > 0) {
          state.month = months[0];
        }
        if (months.length > 1) {
          state.compareMonth = months[1];
        } else {
          state.compareMonth = months[0];
        }
      }

      function setPlanStatus(message, isError = false) {
        planStatus.textContent = message || "";
        if (!message) return;
        planStatus.style.color = isError ? "#b2412e" : "#2f7d55";
        setTimeout(() => {
          if (planStatus.textContent === message) planStatus.textContent = "";
        }, 2400);
      }

      function setRecalcStatus(message, isError = false) {
        if (!recalcStatus) return;
        recalcStatus.textContent = message || "";
        if (!message) return;
        recalcStatus.style.color = isError ? "#b2412e" : "#2f7d55";
        setTimeout(() => {
          if (recalcStatus.textContent === message) recalcStatus.textContent = "";
        }, 2400);
      }

      function buildRawTable(data) {
        if (!data || !data.metrics || data.metrics.length === 0) {
          rawTableContainer.innerHTML = '<div class="empty-state">Нет данных за выбранный период.</div>';
          return;
        }

        const days = data.days || [];
        const weeks = data.weeks || [];
        const metrics = data.metrics || [];

        const table = document.createElement("table");
        table.className = "d1-table raw-table";

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");

        const thMetric = document.createElement("th");
        thMetric.textContent = "Показатель";
        thMetric.className = "metric-col sticky-col";
        headRow.appendChild(thMetric);

        let weekIndex = 0;
        days.forEach((day, idx) => {
          const th = document.createElement("th");
          th.textContent = String(day.day).padStart(2, "0");
          if (day.dow === 5 || day.dow === 6) {
            th.classList.add("day-weekend");
          }
          headRow.appendChild(th);

          if (weekIndex < weeks.length && idx === weeks[weekIndex].end_idx) {
            const thWeek = document.createElement("th");
            thWeek.textContent = "Итог нед.";
            thWeek.className = "week-total";
            headRow.appendChild(thWeek);
            weekIndex += 1;
          }
        });

        const thMonth = document.createElement("th");
        thMonth.textContent = "Итого месяц";
        thMonth.className = "month-total";
        headRow.appendChild(thMonth);

        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        metrics.forEach((metric) => {
          const row = document.createElement("tr");
          const nameCell = document.createElement("th");
          nameCell.textContent = metric.label;
          nameCell.className = "metric-col sticky-col";
          if (metric.is_header) {
            nameCell.classList.add("raw-header");
          }
          row.appendChild(nameCell);

          let idx = 0;
          weekIndex = 0;
          metric.values.forEach((value) => {
            const td = document.createElement("td");
            td.textContent = formatRawValue(value);
            row.appendChild(td);

            if (weekIndex < weeks.length && idx === weeks[weekIndex].end_idx) {
              const weekTd = document.createElement("td");
              weekTd.className = "week-total";
              const weekValue = metric.week_totals[weekIndex];
              weekTd.textContent = formatRawValue(weekValue);
              row.appendChild(weekTd);
              weekIndex += 1;
            }
            idx += 1;
          });

          const monthTd = document.createElement("td");
          monthTd.className = "month-total";
          monthTd.textContent = formatRawValue(metric.month_total);
          row.appendChild(monthTd);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        rawTableContainer.innerHTML = "";
        rawTableContainer.appendChild(table);
      }

      function buildComparisonTable(base, compare) {
        if (!base || !compare || !base.metrics) {
          compareTableContainer.innerHTML = '<div class="empty-state">??? ?????? ??? ?????????.</div>';
          return;
        }

        const metrics = base.metrics || [];
        const compareMap = new Map((compare.metrics || []).map((m) => [m.code, m]));

        const table = document.createElement("table");
        table.className = "d1-table compare-table";

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");

        const thMetric = document.createElement("th");
        thMetric.textContent = "??????????";
        thMetric.className = "metric-col sticky-col";
        headRow.appendChild(thMetric);

        const thA = document.createElement("th");
        thA.textContent = formatMonthLabel(base.month);
        headRow.appendChild(thA);

        const thB = document.createElement("th");
        thB.textContent = formatMonthLabel(compare.month);
        headRow.appendChild(thB);

        const thDelta = document.createElement("th");
        thDelta.textContent = "?";
        headRow.appendChild(thDelta);

        const thDeltaPct = document.createElement("th");
        thDeltaPct.textContent = "?%";
        headRow.appendChild(thDeltaPct);

        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        metrics.forEach((metric) => {
          const row = document.createElement("tr");
          const nameCell = document.createElement("th");
          nameCell.textContent = metric.label;
          nameCell.className = "metric-col sticky-col";
          if (metric.is_header) {
            nameCell.classList.add("raw-header");
          }
          row.appendChild(nameCell);

          const compareMetric = compareMap.get(metric.code);
          const valueA = metric.month_total;
          const valueB = compareMetric ? compareMetric.month_total : null;
          const delta = valueA !== null && valueB !== null ? valueA - valueB : null;
          const deltaPct =
            valueB !== null && valueB !== 0 && delta !== null ? (delta / valueB) * 100 : null;

          const tdA = document.createElement("td");
          tdA.textContent = formatRawValue(valueA);
          row.appendChild(tdA);

          const tdB = document.createElement("td");
          tdB.textContent = formatRawValue(valueB);
          row.appendChild(tdB);

          const tdDelta = document.createElement("td");
          tdDelta.textContent = formatSigned(delta);
          if (delta !== null) tdDelta.classList.add(delta >= 0 ? "delta-positive" : "delta-negative");
          row.appendChild(tdDelta);

          const tdDeltaPct = document.createElement("td");
          tdDeltaPct.textContent = formatSignedPercent(deltaPct);
          if (deltaPct !== null)
            tdDeltaPct.classList.add(deltaPct >= 0 ? "delta-positive" : "delta-negative");
          row.appendChild(tdDeltaPct);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        compareTableContainer.innerHTML = "";
        compareTableContainer.appendChild(table);
      }

      function buildComparisonTSV(base, compare) {
        if (!base || !compare || !base.metrics) return "";
        const metrics = base.metrics || [];
        const compareMap = new Map((compare.metrics || []).map((m) => [m.code, m]));
        const header = [
          "??????????",
          formatMonthLabel(base.month),
          formatMonthLabel(compare.month),
          "?",
          "?%",
        ];
        const lines = [header.join("	")];
        metrics.forEach((metric) => {
          const compareMetric = compareMap.get(metric.code);
          const valueA = metric.month_total;
          const valueB = compareMetric ? compareMetric.month_total : null;
          const delta = valueA !== null && valueB !== null ? valueA - valueB : null;
          const deltaPct =
            valueB !== null && valueB !== 0 && delta !== null ? (delta / valueB) * 100 : null;
          const deltaValue =
            delta !== null ? (delta > 0 ? `+${delta}` : String(delta)) : "";
          const deltaPctValue =
            deltaPct !== null
              ? `${deltaPct > 0 ? "+" : ""}${deltaPct.toFixed(2)}`
              : "";
          lines.push(
            [
              metric.label,
              tsvValue(valueA),
              tsvValue(valueB),
              deltaValue,
              deltaPctValue,
            ].join("	")
          );
        });
        return lines.join("
");
      }

      async function copyCompareTSV() {
        if (!state.compareData) {
          compareCopyStatus.textContent = "Нет данных";
          return;
        }
        const tsv = buildComparisonTSV(state.compareData.base, state.compareData.compare);
        if (!tsv) {
          compareCopyStatus.textContent = "Нет данных";
          return;
        }
        try {
          await navigator.clipboard.writeText(tsv);
          compareCopyStatus.textContent = "Скопировано";
          setTimeout(() => (compareCopyStatus.textContent = ""), 2400);
        } catch (err) {
          compareCopyStatus.textContent = "Не удалось";
          setTimeout(() => (compareCopyStatus.textContent = ""), 2400);
        }
      }

      function buildYearTable(data) {
        if (!data || !data.metrics || data.metrics.length === 0) {
          yearTableContainer.innerHTML = '<div class="empty-state">??? ?????? ??? ??????? ??????.</div>';
          return;
        }

        const months = data.months || [];
        const groups = data.groups || [];
        const metrics = data.metrics || [];

        const monthLabels = {
          "01": "???",
          "02": "???",
          "03": "???",
          "04": "???",
          "05": "???",
          "06": "???",
          "07": "???",
          "08": "???",
          "09": "???",
          "10": "???",
          "11": "???",
          "12": "???",
        };

        const table = document.createElement("table");
        table.className = "d1-table year-table";

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");

        const thMetric = document.createElement("th");
        thMetric.textContent = "??????????";
        thMetric.className = "metric-col sticky-col";
        headRow.appendChild(thMetric);

        months.forEach((month) => {
          const m = month.slice(5, 7);
          const y = month.slice(2, 4);
          const th = document.createElement("th");
          th.className = "month-head";
          th.textContent = `${monthLabels[m] || m} ${y}`;
          headRow.appendChild(th);
        });

        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        const metricMap = new Map(metrics.map((m) => [m.code, m]));

        groups.forEach((group) => {
          const groupRow = document.createElement("tr");
          groupRow.className = "group-row";
          const th = document.createElement("th");
          th.colSpan = months.length + 1;
          th.className = "group-label sticky-col";
          th.textContent = group.label;
          groupRow.appendChild(th);
          tbody.appendChild(groupRow);

          group.metrics.forEach((code) => {
            const metric = metricMap.get(code);
            if (!metric) return;

            const planRow = document.createElement("tr");
            const planLabel = document.createElement("th");
            planLabel.textContent = "????";
            planLabel.className = "metric-col sticky-col";
            planRow.appendChild(planLabel);
            months.forEach((month) => {
              const td = document.createElement("td");
              td.className = "plan-col";
              const input = document.createElement("input");
              input.type = "number";
              input.step = "0.01";
              input.value = metric.plan[month] ?? "";
              input.addEventListener("blur", async (event) => {
                const nextValue = Number(event.target.value || 0);
                try {
                  await savePlan(metric.code, nextValue, month);
                  updateYearPlanLocal(metric.code, month, nextValue);
                  if (state.summaryMonth === month) {
                    updatePlanLocal(metric.code, nextValue);
                    buildTable(state.data);
                  }
                } catch (err) {
                  console.error(err);
                }
              });
              input.addEventListener("keydown", (event) => {
                if (event.key === "Enter") event.target.blur();
              });
              td.appendChild(input);
              planRow.appendChild(td);
            });
            tbody.appendChild(planRow);

            const factRow = document.createElement("tr");
            const factLabel = document.createElement("th");
            factLabel.textContent = metric.label;
            factLabel.className = "metric-col sticky-col";
            factRow.appendChild(factLabel);
            months.forEach((month) => {
              const td = document.createElement("td");
              const factValue = metric.fact[month];
              const planValue = metric.plan[month];
              td.textContent = formatRawValue(factValue);
              if (
                planValue !== null &&
                planValue !== undefined &&
                factValue !== null &&
                factValue !== undefined
              ) {
                td.classList.add(factValue >= planValue ? "fact-above" : "fact-below");
              }
              factRow.appendChild(td);
            });
            tbody.appendChild(factRow);
          });
        });

        table.appendChild(tbody);
        yearTableContainer.innerHTML = "";
        yearTableContainer.appendChild(table);
      }

      function buildYearTSV(data) {
        if (!data || !data.metrics) return "";
        const months = data.months || [];
        const groups = data.groups || [];
        const metrics = data.metrics || [];
        const metricMap = new Map(metrics.map((m) => [m.code, m]));

        const monthLabels = {
          "01": "???",
          "02": "???",
          "03": "???",
          "04": "???",
          "05": "???",
          "06": "???",
          "07": "???",
          "08": "???",
          "09": "???",
          "10": "???",
          "11": "???",
          "12": "???",
        };
        const header = [
          "??????????",
          ...months.map((month) => {
            const m = month.slice(5, 7);
            const y = month.slice(2, 4);
            return `${monthLabels[m] || m} ${y}`;
          }),
        ];
        const lines = [header.join("	")];
        groups.forEach((group) => {
          lines.push([group.label].join("	"));
          group.metrics.forEach((code) => {
            const metric = metricMap.get(code);
            if (!metric) return;
            const planRow = ["????", ...months.map((m) => tsvValue(metric.plan[m]))];
            lines.push(planRow.join("	"));
            const factRow = [metric.label, ...months.map((m) => tsvValue(metric.fact[m]))];
            lines.push(factRow.join("	"));
          });
        });
        return lines.join("
");
      }

      async function copyYearTSV() {
        if (!state.yearData) {
          yearCopyStatus.textContent = "Нет данных";
          return;
        }
        const tsv = buildYearTSV(state.yearData);
        if (!tsv) {
          yearCopyStatus.textContent = "Нет данных";
          return;
        }
        try {
          await navigator.clipboard.writeText(tsv);
          yearCopyStatus.textContent = "Скопировано";
          setTimeout(() => (yearCopyStatus.textContent = ""), 2400);
        } catch (err) {
          yearCopyStatus.textContent = "Не удалось";
          setTimeout(() => (yearCopyStatus.textContent = ""), 2400);
        }
      }

      async function savePlan(metricCode, value, monthValue) {
        const payload = {
          branch_code: state.branchCode,
          month: monthValue || state.month,
          metric_code: metricCode,
          value: value,
        };
        const res = await fetch("/api/cuteam/plans", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          throw new Error("Не удалось сохранить план");
        }
      }

      function updatePlanLocal(metricCode, value) {
        if (!state.data || !state.data.metrics) return;
        state.data.metrics.forEach((metric) => {
          if (metric.code === metricCode) {
            metric.plan = value;
            if (metric.month_total !== null && metric.month_total !== undefined) {
              if (value !== 0) {
                metric.plan_pct = (metric.month_total / value) * 100;
              } else {
                metric.plan_pct = null;
              }
              metric.plan_delta = metric.month_total - value;
            } else {
              metric.plan_pct = null;
              metric.plan_delta = null;
            }
          }
        });
      }

      function updateYearPlanLocal(metricCode, month, value) {
        if (!state.yearData || !state.yearData.metrics) return;
        state.yearData.metrics.forEach((metric) => {
          if (metric.code === metricCode) {
            metric.plan[month] = value;
          }
        });
      }

      function buildTable(data) {
        if (!data || !data.metrics || data.metrics.length === 0) {
          tableContainer.innerHTML = '<div class="empty-state">Нет данных за выбранный период.</div>';
          return;
        }

        const weeks = data.weeks || [];
        const weekLabels = data.week_labels || [];
        const metrics = data.metrics || [];
        const groups = data.groups || {};

        const weekCount = weekLabels.length || weeks.length;
        const totalCols = 2 + weekCount + 3;

        const table = document.createElement("table");
        table.className = "d1-table";

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");

        const thMetric = document.createElement("th");
        thMetric.textContent = "Показатель";
        thMetric.className = "metric-col sticky-col";
        headRow.appendChild(thMetric);

        const thUnit = document.createElement("th");
        thUnit.textContent = "Ед.";
        thUnit.className = "unit-col sticky-col";
        headRow.appendChild(thUnit);

        if (weekLabels.length) {
          weekLabels.forEach((label) => {
            const th = document.createElement("th");
            th.textContent = label;
            th.className = "week-total";
            headRow.appendChild(th);
          });
        } else {
          weeks.forEach((week, idx) => {
            const th = document.createElement("th");
            const start = week.start.slice(8, 10);
            const end = week.end.slice(8, 10);
            th.textContent = `Нед ${idx + 1} (${start}–${end})`;
            th.className = "week-total";
            headRow.appendChild(th);
          });
        }

        const thMonth = document.createElement("th");
        thMonth.textContent = "Итого месяц";
        thMonth.className = "month-total";
        headRow.appendChild(thMonth);

        const thPlan = document.createElement("th");
        thPlan.textContent = "План месяц";
        thPlan.className = "plan-col";
        headRow.appendChild(thPlan);

        const thFact = document.createElement("th");
        thFact.textContent = "Факт vs План";
        thFact.className = "plan-col";
        headRow.appendChild(thFact);

        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        let currentGroup = null;

        metrics.forEach((metric) => {
          if (metric.group !== currentGroup) {
            const groupRow = document.createElement("tr");
            groupRow.className = "group-row";
            const th = document.createElement("th");
            th.colSpan = 2;
            th.className = "group-label sticky-col";
            th.textContent = groups[metric.group] || metric.group;
            groupRow.appendChild(th);
            const fill = document.createElement("td");
            fill.colSpan = totalCols - 2;
            fill.className = "group-fill";
            groupRow.appendChild(fill);
            tbody.appendChild(groupRow);
            currentGroup = metric.group;
          }

          const row = document.createElement("tr");
          const nameCell = document.createElement("th");
          nameCell.textContent = metric.label;
          nameCell.className = "metric-col sticky-col";
          row.appendChild(nameCell);

          const unitCell = document.createElement("td");
          unitCell.textContent =
            metric.unit === "rub"
              ? "руб"
              : metric.unit === "qty"
              ? "шт"
              : metric.unit === "pct"
              ? "%"
              : metric.unit;
          unitCell.className = "unit-col sticky-col";
          row.appendChild(unitCell);

          metric.week_totals.forEach((value) => {
            const td = document.createElement("td");
            td.className = "week-total";
            td.textContent = formatValue(value, metric.unit);
            row.appendChild(td);
          });

          const monthTd = document.createElement("td");
          monthTd.className = "month-total";
          monthTd.textContent = formatValue(metric.month_total, metric.unit);
          row.appendChild(monthTd);

          const planTd = document.createElement("td");
          planTd.className = "plan-col";
          if (metric.plan_enabled) {
            const input = document.createElement("input");
            input.type = "number";
            input.step = "0.01";
            input.value = metric.plan ?? "";
            input.dataset.metricCode = metric.code;
            input.addEventListener("blur", async (event) => {
              const nextValue = Number(event.target.value || 0);
              try {
                await savePlan(metric.code, nextValue, state.summaryMonth || state.month);
                updatePlanLocal(metric.code, nextValue);
                setPlanStatus("План сохранён");
                buildTable(state.data);
              } catch (err) {
                console.error(err);
                setPlanStatus("Ошибка сохранения", true);
              }
            });
            input.addEventListener("keydown", (event) => {
              if (event.key === "Enter") event.target.blur();
            });
            planTd.appendChild(input);
          }
          row.appendChild(planTd);

          const factTd = document.createElement("td");
          factTd.className = "plan-col";
          if (metric.plan_enabled) {
            const summary = formatPlanSummary(metric.plan_pct, metric.plan_delta);
            factTd.textContent = summary;
            if (metric.plan_delta !== null && metric.plan_delta !== undefined) {
              factTd.classList.add(metric.plan_delta >= 0 ? "delta-positive" : "delta-negative");
            }
          }
          row.appendChild(factTd);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        tableContainer.innerHTML = "";
        tableContainer.appendChild(table);
      }

      async function loadSummary() {
        if (!state.branchCode) return;
        if (!state.month) {
          tableContainer.innerHTML =
            '<div class="empty-state">Нет данных для выбранного филиала. Проверьте синхронизацию в админке.</div>';
          return;
        }
        tableContainer.innerHTML = '<div class="empty-state">Загрузка данных…</div>';
        try {
          const data = await fetchJSON(
            `/api/cuteam/d1?branch_code=${encodeURIComponent(state.branchCode)}&month=${encodeURIComponent(state.month)}`
          );
          state.data = data;
          state.summaryMonth = data.month;
          buildTable(data);
        } catch (err) {
          console.error(err);
          tableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить данные.</div>';
        }
      }

      async function loadRaw() {
        if (!state.branchCode) return;
        if (!state.month) {
          rawTableContainer.innerHTML = '<div class="empty-state">Нет данных за выбранный период.</div>';
          return;
        }
        rawTableContainer.innerHTML = '<div class="empty-state">Загрузка данных…</div>';
        try {
          const data = await fetchJSON(
            `/api/cuteam/raw?branch_code=${encodeURIComponent(state.branchCode)}&month=${encodeURIComponent(state.month)}`
          );
          state.rawData = data;
          buildRawTable(data);
        } catch (err) {
          console.error(err);
          rawTableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить данные.</div>';
        }
      }

      async function loadComparison() {
        if (!state.branchCode || !state.month || !state.compareMonth) {
          compareTableContainer.innerHTML = '<div class="empty-state">Нет данных для сравнения.</div>';
          return;
        }
        compareTableContainer.innerHTML = '<div class="empty-state">Загрузка данных…</div>';
        try {
          const base =
            state.rawData && state.rawData.month === state.month
              ? state.rawData
              : await fetchJSON(
                  `/api/cuteam/raw?branch_code=${encodeURIComponent(state.branchCode)}&month=${encodeURIComponent(
                    state.month
                  )}`
                );
          const compare = await fetchJSON(
            `/api/cuteam/raw?branch_code=${encodeURIComponent(state.branchCode)}&month=${encodeURIComponent(
              state.compareMonth
            )}`
          );
          state.compareData = { base, compare };
          buildComparisonTable(base, compare);
        } catch (err) {
          console.error(err);
          compareTableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить данные.</div>';
        }
      }

      async function loadYearSummary() {
        if (!state.branchCode) return;
        yearTableContainer.innerHTML = '<div class="empty-state">Загрузка данных…</div>';
        try {
          const data = await fetchJSON(
            `/api/cuteam/year-summary?branch_code=${encodeURIComponent(state.branchCode)}`
          );
          state.yearData = data;
          buildYearTable(data);
        } catch (err) {
          console.error(err);
          yearTableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить данные.</div>';
        }
      }

      async function loadData() {
        await Promise.all([loadSummary(), loadRaw(), loadComparison(), loadYearSummary()]);
      }

      async function runRecalc() {
        if (!recalcBtn) return;
        recalcBtn.disabled = true;
        const originalLabel = recalcBtn.textContent;
        recalcBtn.textContent = "Запуск…";
        try {
          await fetchJSON("/api/admin/cuteam/sync", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sheet_names: [], dry_run: false }),
          });
          setRecalcStatus("Запущено");
        } catch (err) {
          console.error(err);
          setRecalcStatus("Ошибка запуска", true);
        } finally {
          recalcBtn.disabled = false;
          recalcBtn.textContent = originalLabel || "Пересчитать";
        }
      }

      rawCopyBtn.addEventListener("click", () => {
        copyRawTSV();
      });
      summaryCopyBtn.addEventListener("click", () => {
        copySummaryTSV();
      });
      compareCopyBtn.addEventListener("click", () => {
        copyCompareTSV();
      });
      yearCopyBtn.addEventListener("click", () => {
        copyYearTSV();
      });
      if (recalcBtn) {
        recalcBtn.addEventListener("click", () => {
          runRecalc();
        });
      }

      branchSelect.addEventListener("change", async (event) => {
        state.branchCode = event.target.value;
        await loadMonths();
        monthSelect.value = state.month;
        compareMonthSelect.value = state.compareMonth;
        loadData();
      });

      monthSelect.addEventListener("change", (event) => {
        state.month = event.target.value;
        loadData();
      });

      compareMonthSelect.addEventListener("change", (event) => {
        state.compareMonth = event.target.value;
        loadComparison();
      });

      document.querySelectorAll('input[name="scale"]').forEach((radio) => {
        radio.addEventListener("change", (event) => {
          state.scale = event.target.value;
        });
      });

      (async function init() {
        try {
          await loadBranches();
          if (!state.branchCode) {
            tableContainer.innerHTML = '<div class="empty-state">Нет филиалов для отображения.</div>';
            rawTableContainer.innerHTML = '<div class="empty-state">Нет филиалов для отображения.</div>';
            compareTableContainer.innerHTML = '<div class="empty-state">Нет филиалов для отображения.</div>';
            yearTableContainer.innerHTML = '<div class="empty-state">Нет филиалов для отображения.</div>';
            return;
          }
          await loadMonths();
          monthSelect.value = state.month;
          compareMonthSelect.value = state.compareMonth;
          await loadData();
        } catch (err) {
          console.error(err);
          tableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить настройки.</div>';
          rawTableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить настройки.</div>';
          compareTableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить настройки.</div>';
          yearTableContainer.innerHTML = '<div class="empty-state">Не удалось загрузить настройки.</div>';
        }
      })();
    </script>
  </body>
</html>
